{% extends "base.html" %}
{% from "_order_macros.html" import
    customer_inventory_section,
    file_upload_section,
    new_items_section_cards,
    order_summary_sidebar
%}

{% block title %}Create New Work Order{% endblock %}

{% block styles %}
{{ super() }}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3">
                        <i class="fas fa-plus-circle me-2"></i>Create New Work Order
                    </h1>
                    <p class="text-muted mb-0">Create a new work order and manage inventory items</p>
                </div>

                <div>
                    <a href="{{ url_for('work_orders.list_work_orders') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to List
                    </a>
                </div>
            </div>

            <form method="POST" id="workOrderForm" enctype="multipart/form-data">
                {% if checkin_id %}
                <input type="hidden" name="checkin_id" value="{{ checkin_id }}">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Converting from Check-In #{{ checkin_id }}</strong> - Items and customer info have been pre-filled.
                </div>
                {% endif %}
                <div class="row">
                    <!-- Main Form -->
                    <div class="col-lg-8">
                        <!-- Work Order Details -->
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-info-circle me-2"></i>Work Order Information
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="detail-row">
                                            <div class="detail-label">Customer <span class="text-danger">*</span></div>
                                            <div class="detail-value">
                                                <input type="text"
                                                       class="form-control"
                                                       id="CustID"
                                                       name="CustID"
                                                       required
                                                       value="{% if form_data and form_data.get('CustID') %}{{ form_data.get('CustID') }}{% endif %}">
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">Work Order Number</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-hashtag"></i>
                                                    </span>
                                                    <input type="text" class="form-control" id="next_wo_number" readonly placeholder="Auto-generated">
                                                </div>
                                                <small id="wo-number-display" class="text-muted"></small>
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">Date In</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-calendar-alt"></i>
                                                    </span>
                                                    <input type="date" class="form-control" id="DateIn" name="DateIn"
                                                           value="{{ form_data.get('DateIn', '') if form_data else '' }}" autofocus>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">Name</div>
                                            <div class="detail-value">
                                                <input type="text" class="form-control" id="WOName" name="WOName"
                                                       value="{{ form_data.get('WOName', '') if form_data else '' }}">
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">Location / Rack #</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-map-marker-alt"></i>
                                                    </span>
                                                    <input type="text" class="form-control" id="RackNo" name="RackNo"
                                                           value="{{ form_data.get('RackNo', '') if form_data else '' }}"
                                                           placeholder="e.g., 5 B, bin 4 top, cleaning room">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="detail-row">
                                            <div class="detail-label">Source</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-shipping-fast"></i>
                                                    </span>
                                                    <input type="text" class="form-control" id="ShipTo" name="ShipTo" readonly
                                                           value="{% if form_data and form_data.get('ShipTo') %}{{ form_data.get('ShipTo') }}{% endif %}"
                                                           placeholder="Auto-selected from customer">
                                                </div>
                                                <small class="form-text text-muted">Automatically populated from customer record (cannot be changed)</small>
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">Storage Time</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-clock"></i>
                                                    </span>
                                                    <select class="form-select" id="StorageTime" name="StorageTime">
                                                        <option value="">Select storage duration</option>
                                                        <option value="Seasonal" {% if form_data and form_data.get('StorageTime') == 'Seasonal' %}selected{% endif %}>Seasonal</option>
                                                        <option value="Temporary" {% if form_data and form_data.get('StorageTime') == 'Temporary' %}selected{% endif %}>Temporary</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">Return To</div>
                                            <div class="detail-value">
                                                <select class="form-control" id="ReturnTo" name="ReturnTo">
                                                    <option value="">-- Select --</option>
                                                    <option value="Source" {% if form_data and form_data.get('ReturnTo') == 'Source' %}selected{% endif %}>Source</option>
                                                    <option value="Customer" {% if form_data and form_data.get('ReturnTo') == 'Customer' %}selected{% endif %}>Customer</option>
                                                    <option value="Other" {% if form_data and form_data.get('ReturnTo') == 'Other' %}selected{% endif %}>Other</option>
                                                </select>
                                                <small class="form-text text-muted">Where the package will be returned to</small>
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">Return Status</div>
                                            <div class="detail-value">
                                                <select class="form-control" id="ReturnStatus" name="ReturnStatus">
                                                    <option value="">-- Select --</option>
                                                    <option value="Ship" {% if form_data and form_data.get('ReturnStatus') == 'Ship' %}selected{% endif %}>Ship</option>
                                                    <option value="Deliver" {% if form_data and form_data.get('ReturnStatus') == 'Deliver' %}selected{% endif %}>Deliver</option>
                                                    <option value="Pickup" {% if form_data and form_data.get('ReturnStatus') == 'Pickup' %}selected{% endif %}>Pickup</option>
                                                    <option value="Re-Hang" {% if form_data and form_data.get('ReturnStatus') == 'Re-Hang' %}selected{% endif %}>Re-hang</option>
                                                    <option value="Unknown" {% if form_data and form_data.get('ReturnStatus') == 'Unknown' %}selected{% endif %}>Unknown</option>
                                                </select>
                                                <small class="form-text text-muted">How the order will be returned</small>
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">Priority Options</div>
                                            <div class="detail-value">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="RushOrder" name="RushOrder" value="1"
                                                           {% if form_data and form_data.get('RushOrder') == '1' %}checked{% endif %}>
                                                    <label class="form-check-label" for="RushOrder">
                                                        <span class="badge bg-warning text-dark">
                                                            <i class="fas fa-bolt me-1"></i>Rush Order
                                                        </span>
                                                    </label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="FirmRush" name="FirmRush" value="1"
                                                           {% if form_data and form_data.get('FirmRush') == '1' %}checked{% endif %}>
                                                    <label class="form-check-label" for="FirmRush">
                                                        <span class="badge bg-danger">
                                                            <i class="fas fa-exclamation-triangle me-1"></i>Firm Rush
                                                        </span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="detail-row" id="date-required-row" style="display: none;">
                                            <div class="detail-label">Date Required</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-calendar-check text-danger"></i>
                                                    </span>
                                                    <input type="date" class="form-control" id="DateRequired" name="DateRequired"
                                                           value="{{ form_data.get('DateRequired', '') if form_data else '' }}">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">Clean Date</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-calendar"></i>
                                                    </span>
                                                    <input type="date" class="form-control" id="Clean" name="Clean"
                                                           value="{{ form_data.get('Clean', '') if form_data else '' }}">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">Treat Date</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-calendar"></i>
                                                    </span>
                                                    <input type="date" class="form-control" id="Treat" name="Treat"
                                                           value="{{ form_data.get('Treat', '') if form_data else '' }}">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Instructions & Details -->
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-clipboard-list me-2"></i>Instructions & Details
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="detail-row">
                                            <div class="detail-label">Special Instructions</div>
                                            <div class="detail-value">
                                                <textarea class="form-control" id="SpecialInstructions" name="SpecialInstructions" rows="4"
                                                          placeholder="Enter any special instructions...">{{ form_data.get('SpecialInstructions', '') if form_data else '' }}</textarea>
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">Final Location</div>
                                            <div class="detail-value">
                                                <textarea class="form-control" id="final_location" name="final_location" rows="3"
                                                          placeholder="Enter final location...">{{ form_data.get('final_location', '') if form_data else '' }}</textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="form-check mt-3">
                                            <input class="form-check-input" type="checkbox" id="RepairsNeeded" name="RepairsNeeded" value="true" {% if form_data and form_data.get('RepairsNeeded') %}checked{% endif %}>
                                            <label class="form-check-label" for="RepairsNeeded">
                                                Repairs Needed
                                            </label>
                                        </div>

                                        <div class="detail-row mt-3" id="see-repair-field" style="display: none;">
                                            <div class="detail-label">See Repair</div>
                                            <div class="detail-value">
                                                <input type="text" class="form-control" id="SeeRepair" name="SeeRepair" list="open-repair-orders-list"
                                                       value="{{ form_data.get('SeeRepair', '') if form_data else '' }}">
                                                <datalist id="open-repair-orders-list"></datalist>
                                            </div>
                                        </div>

                                        <div class="detail-row mt-3">
                                            <div class="detail-label">Quote</div>
                                            <div class="detail-value">
                                                <select class="form-select" id="Quote" name="Quote">
                                                    <option value="Yes" {% if form_data and form_data.get('Quote') == 'Yes' %}selected{% endif %}>Yes</option>
                                                    <option value="Approved" {% if form_data and form_data.get('Quote') == 'Approved' %}selected{% endif %}>Approved</option>
                                                    <option value="Done" {% if form_data and form_data.get('Quote') == 'Done' %}selected{% endif %}>Done</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Customer Inventory - SHARED MACRO -->
                        {{ customer_inventory_section() }}

                        <!-- New Items - SHARED MACRO -->
                        {{ new_items_section_cards() }}

                        <!-- File Upload - SHARED MACRO -->
                        {{ file_upload_section() }}
                    </div>

                    <!-- Sidebar -->
                    <div class="col-lg-4">
                        <!-- Order Summary - SHARED MACRO -->
                        {{ order_summary_sidebar() }}

                        <!-- Actions -->
                        <div class="card shadow-sm">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-cogs me-2"></i>Actions
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-save me-2"></i>Create Work Order
                                    </button>
                                    <a href="{{ url_for('work_orders.list_work_orders') }}" class="btn btn-outline-secondary">
                                        <i class="fas fa-arrow-left me-2"></i>Cancel
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Include shared JavaScript -->
<script src="{{ url_for('static', filename='js/order-form-shared.js') }}"></script>

<!-- Work-order-specific JavaScript -->
<script>
// Work order specific: Show/hide See Repair field based on RepairsNeeded checkbox
function updateSeeRepairFieldVisibility() {
    const repairsNeededCheckbox = document.getElementById('RepairsNeeded');
    const seeRepairField = document.getElementById('see-repair-field');

    if (repairsNeededCheckbox.checked) {
        seeRepairField.style.display = 'block';
    } else {
        seeRepairField.style.display = 'none';
    }
}

// Work order specific: Show/hide Date Required field based on FirmRush checkbox
function toggleFirmRush(isChecked) {
    const dateRequiredInput = document.getElementById("date-required-row");
    if (dateRequiredInput) {
        dateRequiredInput.style.display = isChecked ? "block" : "none";
    }
}

// Work order specific: Load open repair orders for autocomplete
function loadOpenRepairOrders(custId) {
    const datalist = document.getElementById('open-repair-orders-list');
    if (!custId) {
        datalist.innerHTML = '';
        return;
    }

    fetch(`/work_orders/api/open_repair_orders/${custId}`)
        .then(response => response.json())
        .then(data => {
            datalist.innerHTML = '';
            data.forEach(order => {
                const option = document.createElement('option');
                option.value = order.RepairOrderNo;
                datalist.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading open repair orders:', error);
        });
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize shared components
    createDatalists();
    initializeFileUpload();

    // Load next work order number
    fetch('/work_orders/api/next_wo_number')
        .then(response => response.json())
        .then(data => {
            document.getElementById('next_wo_number').value = data.next_wo_number;
            document.getElementById('wo-number-display').textContent = `WO-${data.next_wo_number}`;
        })
        .catch(error => {
            console.error('Error loading next WO number:', error);
            document.getElementById('wo-number-display').textContent = 'Error loading WO number';
        });

    // Customer change handler
    document.getElementById('CustID').addEventListener('change', function() {
        const custId = this.value;
        loadCustomerInventory(custId);
        loadOpenRepairOrders(custId);

        // Auto-populate source from customer
        if (custId) {
            fetch(`/customers/api/customer/${custId}`)
                .then(response => response.json())
                .then(customer => {
                    const shipToInput = document.getElementById('ShipTo');
                    if (customer.Source && shipToInput) {
                        shipToInput.value = customer.Source;
                    }
                })
                .catch(error => {
                    console.error('Error loading customer data:', error);
                });
        }
    });

    // If customer is already set, load inventory
    const custInput = document.getElementById('CustID');
    if (custInput.value) {
        loadCustomerInventory(custInput.value);
        loadOpenRepairOrders(custInput.value);
    }

    // RepairsNeeded checkbox handler
    const repairsNeededCheckbox = document.getElementById('RepairsNeeded');
    updateSeeRepairFieldVisibility();
    repairsNeededCheckbox.addEventListener('change', updateSeeRepairFieldVisibility);

    // FirmRush checkbox handler
    const firmRushCheckbox = document.getElementById("FirmRush");
    if (firmRushCheckbox) {
        toggleFirmRush(firmRushCheckbox.checked);
        firmRushCheckbox.addEventListener("change", (e) => {
            toggleFirmRush(e.target.checked);
        });
    }

    // Rush order change handlers
    document.getElementById('RushOrder').addEventListener('change', updateRushStatus);
    document.getElementById('FirmRush').addEventListener('change', updateRushStatus);

    // Form validation
    document.getElementById('workOrderForm').addEventListener('submit', function(e) {
        const custId = document.getElementById('CustID').value;
        if (!custId) {
            e.preventDefault();
            alert('Please select a customer.');
            document.getElementById('CustID').focus();
            return;
        }

        // Check if at least one item is selected or added
        const selectedItems = document.querySelectorAll('input[name="selected_items[]"]:checked').length;
        const newItems = document.querySelectorAll('input[name="new_item_description[]"]').length;

        if (selectedItems === 0 && newItems === 0) {
            e.preventDefault();
            alert('Please select at least one inventory item or add a new item.');
            return;
        }

        // Validate new items have descriptions
        const newItemDescriptions = document.querySelectorAll('input[name="new_item_description[]"]');
        let hasEmptyDescription = false;
        newItemDescriptions.forEach(input => {
            if (!input.value.trim()) {
                hasEmptyDescription = true;
                input.focus();
            }
        });

        if (hasEmptyDescription) {
            e.preventDefault();
            alert('Please provide descriptions for all new items.');
            return;
        }

        // Sanitize SeeRepair field: strip "R" prefix if present (Issue #166)
        // Database stores just the numeric repair order number (e.g., "12345" not "R12345")
        const seeRepairInput = document.getElementById('SeeRepair');
        if (seeRepairInput && seeRepairInput.value) {
            let seeRepairValue = seeRepairInput.value.trim();
            // Remove "R" or "r" prefix if present
            if (seeRepairValue.match(/^[Rr]\d+$/)) {
                seeRepairValue = seeRepairValue.substring(1);
                seeRepairInput.value = seeRepairValue;
            }
        }

        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating...';
        submitBtn.disabled = true;

        // Re-enable button after 10 seconds in case of issues
        setTimeout(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }, 10000);
    });

    // Initialize counts
    updateCounts();

    // Pre-fill items from check-in if converting
    {% if checkin_items %}
    const checkinItems = {{ checkin_items|tojson }};
    if (checkinItems && checkinItems.length > 0) {
        checkinItems.forEach((item, index) => {
            // Add new item row
            addNewItem();

            // Get the last added item container
            const itemCards = document.querySelectorAll('#new-items-container > .item-card-wrapper');
            const lastCard = itemCards[itemCards.length - 1];

            if (lastCard) {
                // Fill in the fields
                lastCard.querySelector('[name="new_item_description[]"]').value = item.description || '';
                lastCard.querySelector('[name="new_item_material[]"]').value = item.material || '';
                lastCard.querySelector('[name="new_item_color[]"]').value = item.color || '';
                lastCard.querySelector('[name="new_item_qty[]"]').value = item.qty || '';
                lastCard.querySelector('[name="new_item_sizewgt[]"]').value = item.sizewgt || '';
                lastCard.querySelector('[name="new_item_price[]"]').value = item.price || '';
                lastCard.querySelector('[name="new_item_condition[]"]').value = item.condition || '';
            }
        });

        // Update counts after adding all items
        setTimeout(() => updateCounts(), 100);
    }
    {% endif %}

    // Pre-select inventory items from check-in (items that had InventoryKey)
    {% if form_data.get('selected_inventory_keys') %}
    const selectedKeys = {{ form_data.get('selected_inventory_keys')|tojson }};
    if (selectedKeys && selectedKeys.length > 0) {
        // Wait a bit for customer inventory to load
        setTimeout(() => {
            selectedKeys.forEach(key => {
                const checkbox = document.querySelector(`input[name="selected_items[]"][value="${key}"]`);
                if (checkbox && !checkbox.checked) {
                    checkbox.checked = true;
                    // Add visual selection
                    const inventoryItem = checkbox.closest('.inventory-item');
                    if (inventoryItem) {
                        inventoryItem.classList.add('selected');
                    }
                }
            });
            // Update counts to reflect selected items
            setTimeout(() => updateCounts(), 100);
        }, 500);
    }
    {% endif %}
});
</script>
{% endblock %}
