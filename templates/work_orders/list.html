{% extends "base.html" %}

{% block title %}Work Orders{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">Work Orders</h1>
        {% if current_user.role != 'user' %}
        <a href="{{ url_for('work_orders.create_work_order') }}" class="btn btn-primary btn-sm">
            <i class="fas fa-plus me-1"></i> Add Work Order
        </a>
        {% endif %}
    </div>

    <!-- Status Filters -->
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <div class="btn-group btn-group-sm" role="group">
            <button id="btn-all" class="btn btn-outline-secondary active">All</button>
            <button id="btn-pending" class="btn btn-outline-warning">Pending</button>
            <button id="btn-rush" class="btn btn-outline-danger">Rush</button>
            <button id="btn-completed" class="btn btn-outline-success">Completed</button>
        </div>
        <small class="text-muted" id="total-work-orders">Loading...</small>
    </div>

    <!-- Table Container -->
    <div class="bg-white rounded-3 shadow-sm border-0">
        <div class="d-flex justify-content-end p-2">
            <button id="clear-filters-btn" class="btn btn-outline-warning btn-sm me-2">
                <i class="fas fa-filter-circle-xmark me-1"></i> Clear Filters
            </button>
            <button id="print-all-pdfs" class="btn btn-outline-primary btn-sm me-2">
                <i class="fas fa-file-pdf me-1"></i> Print All PDFs
            </button>
            <button id="print-table" class="btn btn-outline-secondary btn-sm me-2">
                <i class="fas fa-print me-1"></i> Print Table
            </button>
            <button id="download-csv" class="btn btn-outline-success btn-sm">
                <i class="fas fa-file-csv me-1"></i> Export CSV
            </button>
        </div>
        <div id="work-orders-table"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator_bootstrap5.min.css" rel="stylesheet">
<script src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>

<script>

  // Add this function to your JavaScript file
function dateSorter(a, b, aRow, bRow, column, dir, sorterParams) {
    const dateA = new Date(a);
    const dateB = new Date(b);

    const timeA = dateA.getTime();
    const timeB = dateB.getTime();

    // Handle invalid dates
    if (isNaN(timeA) && isNaN(timeB)) return 0;
    if (isNaN(timeA)) return -1;
    if (isNaN(timeB)) return 1;

    // Sort based on timestamps
    return timeA - timeB;
}

/**
 * Formats a date object or a date string into MM/DD/YYYY format.
 * @param {string|Date} dateValue The date to format.
 * @returns {string} The formatted date string, or an empty string if invalid.
 */
 function formatDate(dateValue) {
    if (!dateValue) {
        return '';
    }

    try {
        const date = new Date(dateValue);

        // Check if the date is a valid date object
        if (isNaN(date.getTime())) {
            return '';
        }

        // Intl.DateTimeFormat is the modern way to handle date formatting
        // It provides better reusability and handles locale-specific formatting
        const formatter = new Intl.DateTimeFormat('en-US', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });

        return formatter.format(date);
    } catch (e) {
        console.error("Failed to format date:", e);
        return '';
    }
}

document.addEventListener("DOMContentLoaded", function() {
    let currentStatus = "";

    const table = window.workOrdersTable = new Tabulator("#work-orders-table", {
        ajaxURL: "{{ url_for('work_orders.api_work_orders') | safe }}",
        ajaxParams: function() {
            const params = { status: currentStatus };

            // Add column header filters
            table.getHeaderFilters().forEach(filter => {
                if(filter.value) params[`filter_${filter.field}`] = filter.value;
            });

            return params;
        },
        pagination: true,
        paginationMode: "remote",
        paginationSize: 25,
        paginationSizeSelector: [10, 25, 50, 100, 250, 500],
        layout: "fitDataFill",
        filterMode: "remote",
        sortMode: "remote",
        multiSort: true,

        // persistence: {
        //     sort: true, // persist column sorting
        //     headerFilter: true, // persist header filters  
        //     page: true, // persist current page and page size
        // },
        
        // Use a unique ID for this table's persistence
        persistenceID: "wo_table",

        columns: [
            {
                title: "WO #",
                field: "WorkOrderNo",
                width: 167,
                headerFilter: function(cell, onRendered, success, cancel, editorParams){
                    const input = document.createElement("input");
                    input.type = "text";
                    input.classList.add("form-control", "form-control-sm", "border-0", "bg-light");
                    input.placeholder = "WO # or range (e.g. 100-200)";

                    onRendered(() => input.focus());

                    input.addEventListener("input", () => success(input.value));
                    return input;
                },
                // Remove headerFilterFunc since we're using remote filtering

                formatter: cell => {
                    const rowData = cell.getRow().getData();
                    let rushBadge = rowData.is_rush ? ' <span class="badge bg-danger ms-1">RUSH</span>' : '';
                    return `<span class="badge bg-primary"><i class="fas fa-hashtag me-1"></i><a href="${rowData.detail_url}">${cell.getValue()}</a></span>${rushBadge}`;
                }
            },

            { title: "Customer", field: "CustID", width: 120, headerFilter: "input",
              formatter: cell => {
                  const row = cell.getRow().getData();
                  return row.customer_url ? `<a href="${row.customer_url}" class="badge bg-info">${cell.getValue()}</a>` : `<span class="text-muted">—</span>`;
              }
            },
            { title: "WO Name", field: "WOName", headerFilter: "input" },
            { title: "Date In", field: "DateIn", headerFilter: "input", 
            sorter: dateSorter,
            sorterParams: {
                format: "YYYY-MM-DD" // Tabulator will parse dates in this format
            },
            formatter: (cell) => formatDate(cell.getValue()) },
            { title: "Date Required", field: "DateRequired", headerFilter: "input",
            sorter: dateSorter,
            sorterParams: {
                format: "YYYY-MM-DD" // Tabulator will parse dates in this format
            },
             formatter: (cell) => formatDate(cell.getValue()) },
            { title: "Source", 
            field: "Source", 
            // width: 140, 
            headerFilter: "input",
            sorter: "string",
              formatter: cell => cell.getValue() ? `<span class="badge bg-info">${cell.getValue()}</span>` : `<span class="text-muted">—</span>` },
            { title: "Actions", field: "actions", width: 120, hozAlign: "center", headerFilter: false, headerSort: false,
              formatter: cell => {
                  const data = cell.getRow().getData();
                  return `
                    <div class="d-flex gap-1 justify-content-center">
                        <a href="${data.detail_url}" class="btn btn-outline-primary btn-sm" title="View">
                            <i class="fas fa-eye"></i>
                        </a>
                        {% set edit_endpoint = 'work_orders.cleaning_room_edit_work_order' if current_user.role == 'user' else 'work_orders.edit_work_order' %}
                        <a href="${data.edit_url}" class="btn btn-outline-warning btn-sm" title="Edit">
                            <i class="fas fa-edit"></i>
                        </a>
                    </div>
                  `;
              },
              print:false,
            }
        ],
        ajaxResponse: function(url, params, response) {
            document.getElementById("total-work-orders").textContent =
                response.total ? `${response.total.toLocaleString()} work orders` : "No work orders";
            return { last_page: response.last_page, data: response.data };
        }
    });

    table.on("tableBuilt", function() {
        // Focus the header filter for the 'WOName' column
        const woNameColumn = table.getColumn("WOName");
        if (woNameColumn) {
            woNameColumn.headerFilterFocus();
        }
    });



    // Print & CSV
    document.getElementById("print-table").addEventListener("click", () => table.print(false, true));
    document.getElementById("download-csv").addEventListener("click", () => table.download("csv", "work_orders.csv"));

    // Print All PDFs - concatenate filtered work orders
    document.getElementById("print-all-pdfs").addEventListener("click", async () => {
        const btn = document.getElementById("print-all-pdfs");
        const originalText = btn.innerHTML;

        try {
            // Get all currently displayed work order numbers
            const data = table.getData();
            const workOrderNumbers = data.map(row => row.WorkOrderNo);

            if (workOrderNumbers.length === 0) {
                alert("No work orders to print");
                return;
            }

            if (workOrderNumbers.length > 100) {
                if (!confirm(`You are about to generate ${workOrderNumbers.length} PDFs. This may take a while. Continue?`)) {
                    return;
                }
            }

            // Show loading state
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Generating PDFs...';

            // Send request to backend
            const response = await fetch("{{ url_for('work_orders.bulk_pdf_work_orders') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    work_order_numbers: workOrderNumbers
                })
            });

            if (!response.ok) {
                throw new Error(`Failed to generate PDFs: ${response.statusText}`);
            }

            // Download the PDF
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `WorkOrders_${new Date().toISOString().slice(0,10)}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

        } catch (error) {
            console.error("Error generating bulk PDF:", error);
            alert("Error generating PDFs: " + error.message);
        } finally {
            // Restore button state
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });

    // Clear all filters button
    document.getElementById("clear-filters-btn").addEventListener("click", () => {
        table.clearHeaderFilter();
        table.setData();
    });

    // Column filter debounce
    let filterTimeout;
    table.on("headerFilterUpdated", (field, value) => {
        clearTimeout(filterTimeout);
        filterTimeout = setTimeout(() => table.setData(), 600);
    });

    // Status buttons
    const setStatus = (status, btn) => {
        currentStatus = status;
        document.querySelectorAll(".btn-group button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        table.setData();
    };

    document.getElementById("btn-all").addEventListener("click", e => setStatus("", e.target));
    document.getElementById("btn-pending").addEventListener("click", e => setStatus("pending", e.target));
    document.getElementById("btn-rush").addEventListener("click", e => setStatus("rush", e.target));
    document.getElementById("btn-completed").addEventListener("click", e => setStatus("completed", e.target));
});


</script>
{% endblock %}
