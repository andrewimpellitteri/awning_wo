{% extends "base.html" %}
{% from "_order_macros.html" import
    customer_inventory_section,
    file_upload_section,
    new_items_section_cards,
    order_summary_sidebar
%}

{% block title %}Edit Work Order {{ work_order.WorkOrderNo }}{% endblock %}

{% block styles %}
{{ super() }}
<style>
.existing-item-card {
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}
.existing-item-card.unchecked {
    background-color: var(--bs-danger-bg-subtle);
    border-color: var(--bs-danger-border-subtle);
    opacity: 0.7;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3">
                        <i class="fas fa-edit me-2"></i>Edit Work Order {{ work_order.WorkOrderNo }}
                    </h1>
                    <p class="text-muted mb-0">
                        Edit work order details and manage inventory items
                        {% if work_order.DateCompleted %}
                            <span class="badge bg-success ms-2">
                                <i class="fas fa-check me-1"></i>Completed
                            </span>
                        {% else %}
                            <span class="badge bg-warning text-dark ms-2">
                                <i class="fas fa-clock me-1"></i>Pending
                            </span>
                        {% endif %}
                    </p>
                </div>

                <div>
                    <a href="{{ url_for('work_orders.view_work_order', work_order_no=work_order.WorkOrderNo, return_url=return_url) }}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-eye me-1"></i>View
                    </a>
                    <a href="{{ return_url }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to List
                    </a>
                </div>
            </div>

            <form method="POST" id="workOrderForm" enctype="multipart/form-data">
                <div class="row">
                    <!-- Main Form -->
                    <div class="col-lg-8">
                        <!-- Work Order Details -->
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-info-circle me-2"></i>Work Order Information
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="detail-row">
                                            <div class="detail-label">Customer <span class="text-danger">*</span></div>
                                            <div class="detail-value">
                                                <input type="text" class="form-control" id="CustID" name="CustID" required
                                                       value="{{ work_order.CustID }}">
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">Work Order Number</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-hashtag"></i>
                                                    </span>
                                                    <input type="text" class="form-control" value="WO-{{ work_order.WorkOrderNo }}" readonly>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">Date In</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-calendar-alt"></i>
                                                    </span>
                                                    <input type="date" class="form-control" id="DateIn" name="DateIn"
                                                           value="{{ work_order.DateIn.strftime('%Y-%m-%d') if work_order.DateIn else '' }}" autofocus>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">Name</div>
                                            <div class="detail-value">
                                                <input type="text" class="form-control" id="WOName" name="WOName"
                                                       value="{{ work_order.WOName or '' }}">
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">Location / Rack #</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-map-marker-alt"></i>
                                                    </span>
                                                    <input type="text" class="form-control" id="RackNo" name="RackNo"
                                                           value="{{ work_order.RackNo or '' }}"
                                                           placeholder="e.g., 5 B, bin 4 top, cleaning room">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="detail-row">
                                            <div class="detail-label">Source</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-shipping-fast"></i>
                                                    </span>
                                                    <input type="text" class="form-control" id="ShipTo" name="ShipTo" readonly
                                                           value="{{ work_order.ShipTo or '' }}"
                                                           placeholder="Auto-selected from customer">
                                                </div>
                                                <small class="form-text text-muted">Automatically populated from customer record (cannot be changed)</small>
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">Storage Time</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-clock"></i>
                                                    </span>
                                                    <select class="form-select" id="StorageTime" name="StorageTime">
                                                        <option value="">Select storage duration</option>
                                                        <option value="Seasonal" {% if work_order.StorageTime == 'Seasonal' %}selected{% endif %}>Seasonal</option>
                                                        <option value="Temporary" {% if work_order.StorageTime == 'Temporary' %}selected{% endif %}>Temporary</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">Return Status</div>
                                            <div class="detail-value">
                                                <select class="form-control" id="ReturnStatus" name="ReturnStatus">
                                                    <option value="">-- Select --</option>
                                                    <option value="Ship" {% if work_order.ReturnStatus == 'Ship' %}selected{% endif %}>Ship</option>
                                                    <option value="Deliver" {% if work_order.ReturnStatus == 'Deliver' %}selected{% endif %}>Deliver</option>
                                                    <option value="Pickup" {% if work_order.ReturnStatus == 'Pickup' %}selected{% endif %}>Pickup</option>
                                                    <option value="Re-Hang" {% if work_order.ReturnStatus == 'Re-Hang' %}selected{% endif %}>Re-hang</option>
                                                    <option value="Unknown" {% if work_order.ReturnStatus == 'Unknown' %}selected{% endif %}>Unknown</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">Priority Options</div>
                                            <div class="detail-value">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="RushOrder" name="RushOrder" value="1"
                                                           {% if work_order.RushOrder %}checked{% endif %}>
                                                    <label class="form-check-label" for="RushOrder">
                                                        <span class="badge bg-warning text-dark">
                                                            <i class="fas fa-bolt me-1"></i>Rush Order
                                                        </span>
                                                    </label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="FirmRush" name="FirmRush" value="1"
                                                           {% if work_order.FirmRush %}checked{% endif %}>
                                                    <label class="form-check-label" for="FirmRush">
                                                        <span class="badge bg-danger">
                                                            <i class="fas fa-exclamation-triangle me-1"></i>Firm Rush
                                                        </span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="detail-row" id="date-required-row" style="display: {% if work_order.FirmRush %}block{% else %}none{% endif %};">
                                            <div class="detail-label">Date Required</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-calendar-check text-danger"></i>
                                                    </span>
                                                    <input type="date" class="form-control" id="DateRequired" name="DateRequired"
                                                           value="{{ work_order.DateRequired.strftime('%Y-%m-%d') if work_order.DateRequired else '' }}">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">Date Completed</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-calendar-check text-success"></i>
                                                    </span>
                                                    <input type="date" class="form-control" id="DateCompleted" name="DateCompleted"
                                                           value="{{ work_order.DateCompleted.strftime('%Y-%m-%d') if work_order.DateCompleted else '' }}">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Instructions & Details -->
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-clipboard-list me-2"></i>Instructions & Details
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="detail-row">
                                            <div class="detail-label">Special Instructions</div>
                                            <div class="detail-value">
                                                <textarea class="form-control" id="SpecialInstructions" name="SpecialInstructions" rows="4"
                                                          placeholder="Enter any special instructions...">{{ work_order.SpecialInstructions or '' }}</textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="form-check mt-3">
                                            <input class="form-check-input" type="checkbox" id="RepairsNeeded" name="RepairsNeeded" value="true" {% if work_order.RepairsNeeded %}checked{% endif %}>
                                            <label class="form-check-label" for="RepairsNeeded">
                                                Repairs Needed
                                            </label>
                                        </div>

                                        <div class="detail-row mt-3" id="see-repair-field" style="display: {% if work_order.RepairsNeeded %}block{% else %}none{% endif %};">
                                            <div class="detail-label">See Repair</div>
                                            <div class="detail-value">
                                                <input type="text" class="form-control" id="SeeRepair" name="SeeRepair" list="open-repair-orders-list"
                                                       value="{{ work_order.SeeRepair or '' }}">
                                                <datalist id="open-repair-orders-list"></datalist>
                                            </div>
                                        </div>

                                        <div class="detail-row mt-3">
                                            <div class="detail-label">Quote</div>
                                            <div class="detail-value">
                                                <select class="form-select" id="Quote" name="Quote">
                                                    <option value="Yes" {% if work_order.Quote == 'Yes' %}selected{% endif %}>Yes</option>
                                                    <option value="Approved" {% if work_order.Quote == 'Approved' %}selected{% endif %}>Approved</option>
                                                    <option value="Done" {% if work_order.Quote == 'Done' %}selected{% endif %}>Done</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Existing Items -->
                        {% if work_order_items %}
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-boxes me-2"></i>Existing Items
                                    <span class="badge bg-success ms-2" id="existing-items-count">{{ work_order_items|length }}</span>
                                </h5>
                                <small class="text-muted">Uncheck items to remove them from the order</small>
                            </div>
                            <div class="card-body">
                                <div id="existing-items">
                                    {% for item in work_order_items %}
                                    <div class="existing-item-card" data-inventory-key="{{ item.InventoryKey or '' }}">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="existing_item_id[]"
                                                   value="{{ item.id if item.id else loop.index }}"
                                                   id="existing_item_{{ item.id if item.id else loop.index }}" checked
                                                   onchange="toggleExistingItem(this)"
                                                   data-inventory-key="{{ item.InventoryKey or '' }}">
                                            <input type="hidden" name="existing_item_inventory_key_{{ item.id if item.id else loop.index }}"
                                                   value="{{ item.InventoryKey or '' }}">
                                            <label class="form-check-label w-100" for="existing_item_{{ item.id if item.id else loop.index }}">
                                                <div class="row align-items-center">
                                                    <div class="col-md-4">
                                                        <div class="detail-label">{{ item.Description }}</div>
                                                        <small class="text-muted">{{ item.Material or 'No material specified' }}</small>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <span class="badge bg-secondary">{{ item.Condition or 'Unknown' }}</span>
                                                        <br><small class="text-muted">{{ item.Color or 'No color' }}</small>
                                                    </div>
                                                    <div class="col-md-2 text-center">
                                                        <small class="text-muted">Size:</small><br>
                                                        <small>{{ item.SizeWgt or '-' }}</small>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label class="form-label small">Price:</label>
                                                        <div class="input-group input-group-sm">
                                                            <span class="input-group-text">$</span>
                                                            <input type="number" class="form-control form-control-sm"
                                                                name="existing_item_price_{{ item.id if item.id else loop.index }}"
                                                                value="{{ item.Price if item.Price else '' }}" step="0.01" min="0"
                                                                onclick="event.stopPropagation()">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-1">
                                                        <label class="form-label small">Qty:</label>
                                                        <input type="number" class="form-control form-control-sm qty-input"
                                                            name="existing_item_qty_{{ item.id if item.id else loop.index }}"
                                                            value="{{ item.Qty or 1 }}" min="1"
                                                            onclick="event.stopPropagation()">
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Customer Inventory - SHARED MACRO -->
                        {{ customer_inventory_section() }}

                        <!-- New Items - SHARED MACRO -->
                        {{ new_items_section_cards() }}

                        <!-- File Upload - SHARED MACRO -->
                        {{ file_upload_section() }}
                    </div>

                    <!-- Sidebar -->
                    <div class="col-lg-4">
                        <!-- Order Summary - SHARED MACRO -->
                        {{ order_summary_sidebar() }}

                        <!-- Actions -->
                        <div class="card shadow-sm">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-cogs me-2"></i>Actions
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-save me-2"></i>Update Work Order
                                    </button>
                                    <a href="{{ url_for('work_orders.view_work_order', work_order_no=work_order.WorkOrderNo, return_url=return_url) }}" class="btn btn-outline-secondary">
                                        <i class="fas fa-eye me-2"></i>View Order
                                    </a>
                                    <a href="{{ return_url }}" class="btn btn-outline-secondary">
                                        <i class="fas fa-arrow-left me-2"></i>Cancel
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Include shared JavaScript -->
<script src="{{ url_for('static', filename='js/order-form-shared.js') }}"></script>

<!-- Work-order-edit-specific JavaScript -->
<script>
let existingItemsCount = {{ work_order_items | length if work_order_items else 0 }};

// Toggle visual appearance of existing items when unchecked
function toggleExistingItem(checkbox) {
    const card = checkbox.closest('.existing-item-card');
    if (checkbox.checked) {
        card.classList.remove('unchecked');
    } else {
        card.classList.add('unchecked');
    }
    updateExistingCount();

    // Refresh customer inventory to show/hide items dynamically
    const custId = document.getElementById('CustID').value;
    if (custId) {
        loadCustomerInventory(custId);
    }
}

// Update count of checked existing items
function updateExistingCount() {
    const checkedExisting = document.querySelectorAll('input[name="existing_item_id[]"]:checked').length;
    document.getElementById('existing-items-count').textContent = checkedExisting;
}

// Work order specific: Show/hide See Repair field based on RepairsNeeded checkbox
function updateSeeRepairFieldVisibility() {
    const repairsNeededCheckbox = document.getElementById('RepairsNeeded');
    const seeRepairField = document.getElementById('see-repair-field');

    if (repairsNeededCheckbox.checked) {
        seeRepairField.style.display = 'block';
    } else {
        seeRepairField.style.display = 'none';
    }
}

// Work order specific: Show/hide Date Required field based on FirmRush checkbox
function toggleFirmRush(isChecked) {
    const dateRequiredInput = document.getElementById("date-required-row");
    if (dateRequiredInput) {
        dateRequiredInput.style.display = isChecked ? "block" : "none";
    }
}

// Work order specific: Load open repair orders for autocomplete
function loadOpenRepairOrders(custId) {
    const datalist = document.getElementById('open-repair-orders-list');
    if (!custId) {
        datalist.innerHTML = '';
        return;
    }

    fetch(`/work_orders/api/open_repair_orders/${custId}`)
        .then(response => response.json())
        .then(data => {
            datalist.innerHTML = '';
            data.forEach(order => {
                const option = document.createElement('option');
                option.value = order.RepairOrderNo;
                datalist.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading open repair orders:', error);
        });
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize shared components
    createDatalists();
    initializeFileUpload();

    // Customer change handler
    document.getElementById('CustID').addEventListener('change', function() {
        const custId = this.value;
        loadCustomerInventory(custId);
        loadOpenRepairOrders(custId);

        // Auto-populate source from customer
        if (custId) {
            fetch(`/customers/api/customer/${custId}`)
                .then(response => response.json())
                .then(customer => {
                    const shipToInput = document.getElementById('ShipTo');
                    if (customer.Source && shipToInput) {
                        shipToInput.value = customer.Source;
                    }
                })
                .catch(error => {
                    console.error('Error loading customer data:', error);
                });
        }
    });

    // Load customer inventory on page load
    const custId = document.getElementById('CustID').value;
    if (custId) {
        loadCustomerInventory(custId);
        loadOpenRepairOrders(custId);
    }

    // RepairsNeeded checkbox handler
    const repairsNeededCheckbox = document.getElementById('RepairsNeeded');
    updateSeeRepairFieldVisibility();
    repairsNeededCheckbox.addEventListener('change', updateSeeRepairFieldVisibility);

    // FirmRush checkbox handler
    const firmRushCheckbox = document.getElementById("FirmRush");
    if (firmRushCheckbox) {
        toggleFirmRush(firmRushCheckbox.checked);
        firmRushCheckbox.addEventListener("change", (e) => {
            toggleFirmRush(e.target.checked);
        });
    }

    // Rush order change handlers
    document.getElementById('RushOrder').addEventListener('change', updateRushStatus);
    document.getElementById('FirmRush').addEventListener('change', updateRushStatus);

    // Form validation
    document.getElementById('workOrderForm').addEventListener('submit', function(e) {
        const custId = document.getElementById('CustID').value;
        if (!custId) {
            e.preventDefault();
            alert('Please select a customer.');
            document.getElementById('CustID').focus();
            return;
        }

        // Check if at least one item exists or is added
        const selectedItems = document.querySelectorAll('input[name="selected_items[]"]:checked').length;
        const newItems = document.querySelectorAll('input[name="new_item_description[]"]').length;
        const existingItems = document.querySelectorAll('input[name="existing_item_id[]"]:checked').length;

        if (selectedItems === 0 && newItems === 0 && existingItems === 0) {
            e.preventDefault();
            alert('Please keep at least one existing item, select an inventory item, or add a new item.');
            return;
        }

        // Validate new items have descriptions
        const newItemDescriptions = document.querySelectorAll('input[name="new_item_description[]"]');
        let hasEmptyDescription = false;
        newItemDescriptions.forEach(input => {
            if (!input.value.trim()) {
                hasEmptyDescription = true;
                input.focus();
            }
        });

        if (hasEmptyDescription) {
            e.preventDefault();
            alert('Please provide descriptions for all new items.');
            return;
        }

        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
        submitBtn.disabled = true;

        // Re-enable button after 10 seconds in case of issues
        setTimeout(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }, 10000);
    });

    // Initialize counts and rush status
    updateCounts();
    updateRushStatus();
});
</script>
{% endblock %}
