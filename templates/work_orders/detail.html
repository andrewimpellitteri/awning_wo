{% extends "base.html" %}

{% block title %}Work Order {{ work_order.WorkOrderNo }}{% endblock %}

{% block styles %}
{{ super() }}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3">
                        <i class="fas fa-clipboard-list me-2"></i>
                        Work Order {{ work_order.WorkOrderNo }}
                        {% if work_order.RushOrder == "YES" or work_order.FirmRush == "YES" %}
                        <span class="badge bg-danger ms-2">
                            <i class="fas fa-bolt me-1"></i>RUSH ORDER
                        </span>
                        {% endif %}
                    </h1>
                    <p class="text-muted mb-0">{{ work_order.WOName or 'Unnamed Order' }}</p>
                </div>
                
                <div class="d-flex gap-2">
                    <div class="dropdown">
                        <button class="btn btn-info dropdown-toggle" type="button" id="pdfDropdown5" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-file-pdf"></i> PDF Options
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="pdfDropdown5">
                            <li><a class="dropdown-item" href="{{ url_for('work_orders.download_work_order_pdf', work_order_no=work_order.WorkOrderNo) }}">
                                <i class="fas fa-download"></i> Download PDF
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('work_orders.view_work_order_pdf', work_order_no=work_order.WorkOrderNo) }}" target="_blank">
                                <i class="fas fa-eye"></i> View PDF
                            </a></li>
                        </ul>
                    </div>
                    
                    {% set edit_endpoint = 'work_orders.cleaning_room_edit_work_order' if current_user.role == 'user' else 'work_orders.edit_work_order' %}
                    <a href="{{ url_for(edit_endpoint, work_order_no=work_order.WorkOrderNo) }}"
                    class="btn btn-primary">
                        <i class="fas fa-edit me-1"></i>Edit
                    </a>
                    <a href="{{ url_for('work_orders.list_work_orders') }}" 
                       class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to List
                    </a>
                    {%  if current_user.role != 'user' %}
                    <form action="{{ url_for('work_orders.delete_work_order', work_order_no=work_order.WorkOrderNo) }}" 
                          method="POST" onsubmit="return confirm('Are you sure you want to delete this work order?');" 
                          class="m-0">
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash-alt me-1"></i>Delete
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
            
            <div class="row">
                <!-- Left Column -->
                <div class="col-lg-6">
                    <!-- Work Order Header Card -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-info-circle me-2"></i> Work Order Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Left Column -->
                                <div class="col-md-6">
                                    <div class="detail-row">
                                        <div class="detail-label">Work Order Number</div>
                                        <div class="detail-value">
                                            <span class="badge bg-primary">
                                                <i class="fas fa-hashtag me-1"></i>{{ work_order.WorkOrderNo }}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div class="detail-row">
                                        <div class="detail-label">Customer ID</div>
                                        <div class="detail-value">
                                            {% if work_order.customer %}
                                                <a href="{{ url_for('customers.customer_detail', customer_id=work_order.customer.CustID) }}" 
                                                   class="text-decoration-none">
                                                    <span class="badge bg-primary">
                                                        <i class="fas fa-user me-1"></i>{{ work_order.CustID }}
                                                    </span>
                                                </a>
                                            {% else %}
                                                <span class="text-muted fst-italic">Not assigned</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="detail-row">
                                        <div class="detail-label">Work Order Name</div>
                                        <div class="detail-value">{{ work_order.WOName or '<span class="text-muted">-</span>' | safe }}</div>
                                    </div>
                                    
                                    <div class="detail-row">
                                        <div class="detail-label">Storage</div>
                                        <div class="detail-value">{{ work_order.Storage or '<span class="text-muted">-</span>' | safe }}</div>
                                    </div>
                                    
                                    <div class="detail-row">
                                        <div class="detail-label">Storage Time</div>
                                        <div class="detail-value">{{ work_order.StorageTime or '<span class="text-muted">-</span>' | safe }}</div>
                                    </div>
                                    
                                    <div class="detail-row">
                                        <div class="detail-label">Rack #</div>
                                        <div class="detail-value">
                                            {% if work_order.RackNo %}
                                                <span class="badge bg-secondary">
                                                    <i class="fas fa-layer-group me-1"></i>{{ work_order.RackNo }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="detail-row">
                                        <div class="detail-label">Special Instructions</div>
                                        <div class="detail-value">{{ work_order.SpecialInstructions or '<span class="text-muted">-</span>' | safe }}</div>
                                    </div>
                                    
                                    <div class="detail-row">
                                        <div class="detail-label">Repairs Needed</div>
                                        <div class="detail-value">{{ work_order.RepairsNeeded or '<span class="text-muted">-</span>' | safe }}</div>
                                    </div>
                                    
                                    <div class="detail-row">
                                        <div class="detail-label">See Repair</div>
                                        <div class="detail-value">
                                            {% if work_order.SeeRepair %}
                                                {% set repair_num = work_order.SeeRepair %}
                                                {% if repair_num.startswith('R') %}
                                                    {% set repair_num = repair_num[1:] %}
                                                {% endif %}
                                                <a href="{{ url_for('repair_work_orders.view_repair_work_order', repair_order_no=repair_num) }}" class="badge bg-primary">
                                                    {{ work_order.SeeRepair }}
                                                </a>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                
                                </div>
                                
                                <!-- Right Column -->
                                <div class="col-md-6">
                                    <div class="detail-row">
                                        <div class="detail-label">Date Required</div>
                                        <div class="detail-value">
                                            <i class="fas fa-calendar-check text-danger me-2"></i>
                                            {{ (work_order.DateRequired | date_format) or '<span class="text-muted">-</span>' | safe }}
                                        </div>
                                    </div>
                                    
                                    <div class="detail-row">
                                        <div class="detail-label">Date In</div>
                                        <div class="detail-value">
                                            <i class="fas fa-calendar-plus text-success me-2"></i>
                                            {{ (work_order.DateIn | date_format) or '<span class="text-muted">-</span>' | safe }}
                                        </div>
                                    </div>
                                    
                                    <div class="detail-row">
                                        <div class="detail-label">Date Completed</div>
                                        <div class="detail-value">
                                            <i class="fas fa-calendar-check text-primary me-2"></i>
                                            {{ (work_order.DateCompleted | date_format) or '<span class="text-muted">-</span>' | safe }}
                                        </div>
                                    </div>
                                    
                                    <div class="detail-row">
                                        <div class="detail-label">Source</div>
                                        <div class="detail-value">
                                            {% if work_order.customer.source_info %}
                                                <a href="{{ url_for('source.source_detail', source_name=work_order.customer.source_info.SSource) }}" 
                                                   class="text-decoration-none">
                                                    <span class="badge bg-info">
                                                        <i class="fas fa-shipping-fast me-1"></i>{{ work_order.customer.source_info.SSource }}
                                                    </span>
                                                </a>
                                            {% else %}
                                                <span class="text-muted fst-italic">Not assigned</span>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="detail-row">
                                        <div class="detail-label">Return Status</div>
                                        <div class="detail-value">
                                            <span class="badge bg-info">{{ work_order.ReturnStatus or 'Not Set' }}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="detail-row">
                                        <div class="detail-label">Rush Order</div>
                                        <div class="detail-value">
                                            {% if (work_order.RushOrder | yesdash) != '-' %}
                                                <span class="badge bg-warning text-dark">
                                                    <i class="fas fa-bolt me-1"></i>{{ (work_order.RushOrder | yesdash) }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="detail-row">
                                        <div class="detail-label">Firm Rush</div>
                                        <div class="detail-value">
                                            {% if (work_order.FirmRush | yesdash) != '-' %}
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>{{ (work_order.FirmRush | yesdash) }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="detail-row">
                                        <div class="detail-label">Clean</div>
                                        <div class="detail-value">
                                            <i class="fas fa-calendar-alt text-muted me-2"></i>
                                            {{ (work_order.Clean | date_format) or '<span class="text-muted">-</span>' | safe }}
                                        </div>
                                    </div>
                                    
                                    <div class="detail-row">
                                        <div class="detail-label">Treat</div>
                                        <div class="detail-value">
                                            <i class="fas fa-calendar-alt text-muted me-2"></i>
                                            {{ (work_order.Treat | date_format) or '<span class="text-muted">-</span>' | safe }}
                                        </div>
                                    </div>
                                    
                                    <div class="detail-row">
                                        <div class="detail-label">Clean First WO</div>
                                        <div class="detail-value">{{ work_order.CleanFirstWO or '<span class="text-muted">-</span>' | safe }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="col-lg-6">
                    {% if work_order.files %}
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-file me-2"></i> Uploaded Files
                                <span class="badge bg-primary ms-2">{{ files|length }}</span>
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <!-- Grid layout for file thumbnails -->
                            <div class="file-grid p-3">
                                {% for file in work_order.files %}
                                    <div class="file-item" data-file-id="{{ file.id }}">
                                        <!-- Thumbnail container -->
                                        <div class="file-thumbnail-container">
                                            {% if file.thumbnail_path %}
                                                <!-- Show actual thumbnail -->
                                                <img src="{{ url_for('work_orders.get_thumbnail', file_id=file.id) }}" 
                                                    alt="{{ file.filename }}" 
                                                    class="file-thumbnail"
                                                    loading="lazy"
                                                    onerror="this.parentElement.innerHTML='<div class=\'file-icon\'><i class=\'fas fa-file\'></i></div>'">
                                            {% else %}
                                                <!-- Show file type icon -->
                                                <div class="file-icon">
                                                    {% set file_ext = file.filename.split('.')[-1].lower() %}
                                                    {% if file_ext in ['jpg', 'jpeg', 'png', 'gif', 'bmp'] %}
                                                        <i class="fas fa-image text-success"></i>
                                                    {% elif file_ext == 'pdf' %}
                                                        <i class="fas fa-file-pdf text-danger"></i>
                                                    {% elif file_ext in ['doc', 'docx'] %}
                                                        <i class="fas fa-file-word text-primary"></i>
                                                    {% elif file_ext in ['xls', 'xlsx'] %}
                                                        <i class="fas fa-file-excel text-success"></i>
                                                    {% elif file_ext == 'csv' %}
                                                        <i class="fas fa-file-csv text-info"></i>
                                                    {% elif file_ext == 'txt' %}
                                                        <i class="fas fa-file-alt text-secondary"></i>
                                                    {% else %}
                                                        <i class="fas fa-file text-muted"></i>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                            
                                            <!-- Hover overlay -->
                                            <div class="file-overlay">
                                                <div class="file-actions">
                                                    <a href="{{ url_for('work_orders.download_work_order_file',
                                                                        work_order_no=work_order.WorkOrderNo,
                                                                        file_id=file.id) }}"
                                                    class="btn btn-sm btn-light me-2" 
                                                    title="Download">
                                                        <i class="fas fa-download"></i>
                                                    </a>
                                                    <button class="btn btn-sm btn-light" 
                                                            title="View Details"
                                                            onclick="showFileDetails({{ file.id }}, '{{ file.filename }}', '{{ file.file_path }}')">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- File info -->
                                        <div class="file-info">
                                            <div class="file-name" title="{{ file.filename }}">
                                                {{ file.filename | truncate(20) }}
                                            </div>
                                            <div class="file-meta">
                                                {% set file_size = get_file_size(file.file_path) %}
                                                {% if file_size %}
                                                    <small class="text-muted">{{ file_size }}</small>
                                                {% endif %}
                                                {% if file.uploaded_at %}
                                                    <small class="text-muted d-block">{{ file.uploaded_at.strftime('%m/%d/%Y') }}</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- File Details Modal -->
                    <div class="modal fade" id="fileDetailsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">File Details</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div id="fileDetailsContent">
                                        <!-- Content loaded dynamically -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status Card -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-flag me-2"></i> Status
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="detail-row">
                                <div class="detail-label">Cleaning Status</div>
                                <div class="detail-value">
                                    <div class="order-status" role="status" aria-live="polite">
                                    {% if work_order.DateCompleted %}
                                        <!-- Completed -->
                                        <span class="badge bg-success d-inline-flex align-items-center">
                                        <i class="fas fa-check me-1" aria-hidden="true"></i>
                                        <span class="visually-hidden">Completed</span>
                                        Completed
                                        </span>
                                    {% elif work_order.Treat %}
                                        <!-- Ready to ship/pick up -->
                                        <span class="badge bg-info d-inline-flex align-items-center">
                                        <i class="fas fa-box me-1" aria-hidden="true"></i>
                                        <span class="visually-hidden">Ready to ship or pick up</span>
                                        Ready to ship/pick up
                                        </span>
                                    {% elif work_order.ProcessingStatus %}
                                        <!-- In progress -->
                                        <span class="d-inline-flex align-items-center status-inprogress" title="In progress">
                                        <span class="status-dot" aria-hidden="true"></span>
                                        <span class="ms-1">In progress</span>
                                        </span>
                                    {% else %}
                                        <!-- Not started / fallback -->
                                        <span class="text-muted">Not started</span>
                                    {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quote Information Card -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-dollar-sign me-2"></i> Quote Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="detail-row">
                                <div class="detail-label">Quote</div>
                                <div class="detail-value">{{ work_order.Quote or '<span class="text-muted">Not provided</span>' | safe }}</div>
                            </div>
                        </div>
                    </div>
                    <!-- System Information / Timestamps -->
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-clock me-2"></i> System Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="detail-row">
                                <div class="detail-label">Created</div>
                                <div class="detail-value">
                                    <i class="fas fa-plus-circle text-success me-2"></i>
                                    <small>{{ (work_order.created_at | date_format) or '<span class="text-muted">Unknown</span>' | safe }}</small>
                                </div>
                            </div>
                            
                            <div class="detail-row">
                                <div class="detail-label">Updated</div>
                                <div class="detail-value">
                                    <i class="fas fa-edit text-info me-2"></i>
                                    <small>{{ (work_order.updated_at | date_format) or '<span class="text-muted">Unknown</span>' | safe }}</small>
                                </div>
                            </div>
                            {% if not work_order.DateCompleted %}
                            <div class="card mt-3">
                                <div class="card-header bg-primary text-white">
                                    <i class="fas fa-robot me-1"></i> ML Estimate
                                </div>
                                <div class="card-body">
                                    <div id="ml-estimate-card">
                                    <span class="text-muted">Loading estimate...</span>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                </div>
                <div class="card mb-4 shadow-sm">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list me-2"></i> Order Items
                            {% if work_order.items %}
                            <span class="badge bg-secondary ms-2">{{ work_order.items|length }}</span>
                            {% endif %}
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if work_order.items %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="bg-light" style="border-bottom: 1px solid #adb5bd;">
                                    <tr>
                                        <th>Qty</th>
                                        <th>Description</th>
                                        <th>Material</th>
                                        <th>Condition</th>
                                        <th>Color</th>
                                        <th>Size/Weight</th>
                                        <th>Price</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in work_order.items %}
                                    <tr>
                                        <td>{{ item.Qty | int or '-' }}</td>
                                        <td>{{ item.Description or '-' }}</td>
                                        <td>{{ item.Material or '-' }}</td>
                                        <td>{{ item.Condition or '-' }}</td>
                                        <td>{{ item.Color or '-' }}</td>
                                        <td>{{ item.SizeWgt or '-' }}</td>
                                        <td>{{ (item.Price | price_format) or '-' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                            <p class="text-muted mb-0">No items for this work order.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const orderNo = "{{ work_order.WorkOrderNo }}";
        const estimateUrl = "{{ url_for('ml.predict_work_order', work_order_no=work_order.WorkOrderNo) }}";
    
        fetch(estimateUrl)
            .then(response => response.json())
            .then(data => {
                let html = "";
                if (data.error) {
                    html = `<span class="text-danger">${data.error}</span>`;
                } else {
                    html = `
                        <div class="detail-row">
                            <div class="detail-label">Predicted Days</div>
                            <div class="detail-value">
                                <span class="badge bg-success">
                                    ${data.predicted_days} days
                                </span>
                            </div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Estimated Completion</div>
                            <div class="detail-value">
                                <span class="badge bg-info">
                                    ${data.estimated_completion}
                                </span>
                            </div>
                        </div>
                    `;
                }
                document.getElementById("ml-estimate-card").innerHTML = html;
            })
            .catch(err => {
                document.getElementById("ml-estimate-card").innerHTML =
                    `<span class="text-danger">Failed to load estimate</span>`;
            });
    });

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.file-item').forEach(item => {
        const filename = item.querySelector('.file-name').textContent.trim();
        const ext = filename.split('.').pop().toLowerCase();
        
        let type = 'unknown';
        if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(ext)) {
            type = 'image';
        } else if (ext === 'pdf') {
            type = 'pdf';
        } else if (['doc', 'docx'].includes(ext)) {
            type = 'document';
        } else if (['xls', 'xlsx', 'csv'].includes(ext)) {
            type = 'spreadsheet';
        } else if (ext === 'txt') {
            type = 'text';
        }
        
        item.setAttribute('data-type', type);
    });
});
</script>    
{% endblock %}