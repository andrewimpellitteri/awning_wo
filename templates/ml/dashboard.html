{% extends "base.html" %}

{% block title %}ML Dashboard{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1><i class="fas fa-brain me-2"></i>ML Model Dashboard</h1>

    <!-- Model Status -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Model Status</h5>
        </div>
        <div class="card-body">
            <div class="row text-center" id="modelStatus">
                <div class="col-md-3">
                    <h3 id="modelTrained" class="text-primary display-4">❌</h3>
                    <p class="text-muted">Model Trained</p>
                </div>
                <div class="col-md-3">
                    <h3 id="mae" class="text-primary display-4">--</h3>
                    <p class="text-muted">MAE (days)</p>
                </div>
                <div class="col-md-3">
                    <h3 id="r2" class="text-primary display-4">--</h3>
                    <p class="text-muted">R² Score</p>
                </div>
                <div class="col-md-3">
                    <h3 id="samples" class="text-primary display-4">--</h3>
                    <p class="text-muted">Training Samples</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Actions</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6 col-lg-4">
                    <button class="btn btn-primary w-100" onclick="getStatus()">
                        <i class="fas fa-sync me-1"></i> Refresh Status
                    </button>
                </div>
                <div class="col-md-6 col-lg-4">
                    <button class="btn btn-success w-100" onclick="trainModel('baseline')">
                        <i class="fas fa-running me-1"></i> Train Baseline (Fast)
                    </button>
                </div>
                <div class="col-md-6 col-lg-4">
                    <button class="btn btn-warning w-100" onclick="trainModel('deep_wide')">
                        <i class="fas fa-bolt me-1"></i> Train Deep+Wide (Best)
                    </button>
                </div>
                <div class="col-md-6 col-lg-4">
                    <button class="btn btn-info w-100" onclick="testPredict()">
                        <i class="fas fa-crystal-ball me-1"></i> Test Prediction
                    </button>
                </div>
                <div class="col-md-6 col-lg-4">
                    <button class="btn btn-info w-100" onclick="batchPredict()">
                        <i class="fas fa-list me-1"></i> Batch Predict
                    </button>
                </div>
            </div>
            
            <div class="d-none text-center mt-3" id="loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Processing...</p>
            </div>
        </div>
    </div>

    <!-- Activity Log -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Activity Log</h5>
            <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">
                <i class="fas fa-trash me-1"></i> Clear Log
            </button>
        </div>
        <div class="card-body">
            <div id="log" class="bg-light p-3 rounded" style="height: 300px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.4;">
            </div>
        </div>
    </div>
</div>

<style>
.log-success { color: #198754; }
.log-error { color: #dc3545; }
.log-info { color: #0dcaf0; }
</style>

<script>
    // Log function
    function log(message, type = 'info') {
        const logDiv = document.getElementById('log');
        const timestamp = new Date().toLocaleTimeString();
        const className = type === 'error' ? 'log-error' : type === 'success' ? 'log-success' : type === 'info' ? 'log-info' : '';
        logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLog() {
        document.getElementById('log').innerHTML = '';
    }

    function showLoading(show = true) {
        const loadingDiv = document.getElementById('loading');
        if (show) {
            loadingDiv.classList.remove('d-none');
        } else {
            loadingDiv.classList.add('d-none');
        }
    }

    // Get model status
    async function getStatus() {
        try {
            log('Fetching model status...');
            const response = await fetch('/ml/status');
            const data = await response.json();
            
            // Update UI
            document.getElementById('modelTrained').textContent = data.trained ? '✅' : '❌';
            document.getElementById('mae').textContent = data.metadata.mae || '--';
            document.getElementById('r2').textContent = data.metadata.r2 ? `${(data.metadata.r2 * 100).toFixed(1)}%` : '--';
            document.getElementById('samples').textContent = data.metadata.sample_count || '--';
            
            log(`Status updated. Model trained: ${data.trained}`, 'success');
            
            if (data.trained) {
                log(`Current model: ${data.metadata.config_name} (MAE: ${data.metadata.mae}, R²: ${data.metadata.r2})`, 'success');
            }
            
        } catch (error) {
            log(`Error fetching status: ${error.message}`, 'error');
        }
    }

    // Train model
    async function trainModel(config) {
        try {
            showLoading(true);
            log(`Starting training with config: ${config}...`);
            
            const response = await fetch('/ml/train', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ config: config })
            });
            
            const data = await response.json();
            showLoading(false);
            
            if (response.ok) {
                log(`Training completed! MAE: ${data.metrics.mae.toFixed(3)}, R²: ${data.metrics.r2.toFixed(3)}, Time: ${data.metrics.training_time.toFixed(1)}s`, 'success');
                getStatus(); // Refresh status
            } else {
                log(`Training failed: ${data.error}`, 'error');
            }
            
        } catch (error) {
            showLoading(false);
            log(`Training error: ${error.message}`, 'error');
        }
    }

    // Test prediction
    async function testPredict() {
        try {
            log('Making test prediction...');
            
            const testData = {
                custid: 'TEST001',
                datein: new Date().toISOString().split('T')[0],
                rushorder: false,
                firmrush: false,
                storagetime: 0,
                specialinstructions: 'Test order for prediction',
                repairsneeded: 'Minor cleaning required'
            };
            
            const response = await fetch('/ml/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(testData)
            });
            
            const data = await response.json();
            
            if (response.ok) {
                log(`Prediction: ${data.predicted_days} days (${data.confidence_interval.lower}-${data.confidence_interval.upper} days range)`, 'success');
                log(`Estimated completion: ${data.estimated_completion}`, 'success');
            } else {
                log(`Prediction failed: ${data.error}`, 'error');
            }
            
        } catch (error) {
            log(`Prediction error: ${error.message}`, 'error');
        }
    }

    // Batch predict
    async function batchPredict() {
        try {
            showLoading(true);
            log('Running batch predictions...');
            
            const response = await fetch('/ml/batch_predict');
            const data = await response.json();
            showLoading(false);
            
            if (response.ok) {
                log(`Batch prediction completed: ${data.results.length} orders processed`, 'success');
                
                // Show first few results
                data.results.slice(0, 3).forEach(result => {
                    log(`  ${result.work_order}: ${result.predicted_days} days${result.rush_order ? ' (RUSH)' : ''}`, 'info');
                });
                
                if (data.results.length > 3) {
                    log(`  ... and ${data.results.length - 3} more orders`, 'info');
                }
            } else {
                log(`Batch prediction failed: ${data.error}`, 'error');
            }
            
        } catch (error) {
            showLoading(false);
            log(`Batch prediction error: ${error.message}`, 'error');
        }
    }

    // Load status on page load
    document.addEventListener('DOMContentLoaded', function() {
        log('Dashboard loaded');
        getStatus();
    });
</script>
{% endblock %}