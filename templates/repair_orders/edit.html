{% extends "base.html" %}

{% block title %}Edit Repair Work Order #{{ repair_work_order.RepairOrderNo }}{% endblock %}

{% block styles %}
{{ super() }}
<style>
.item-row.marked-for-deletion {
  background-color: var(--bs-danger-bg-subtle);
  border-color: var(--bs-danger-border-subtle);
  opacity: 0.7;
}
.new-item-row {
  background-color: var(--bs-info-bg-subtle);
  border: 1px solid var(--bs-info-border-subtle);
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
}
.text-strike {
  text-decoration: line-through;
}
</style>

{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3"><i class="fas fa-edit me-2"></i>Edit Work Order #R{{ repair_work_order.RepairOrderNo }}</h1>
                    <p class="text-muted mb-0">Modify work order details and manage items</p>
                </div>
                <div>
                    <a href="{{ url_for('repair_work_orders.view_repair_work_order', repair_order_no=repair_work_order.RepairOrderNo) }}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-eye me-1"></i>View Order
                    </a>
                    <a href="{{ url_for('repair_work_orders.list_repair_work_orders') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to List
                    </a>
                </div>
            </div>

            <form method="POST" id="editOrderForm" enctype="multipart/form-data">
                <div class="row">
                    <div class="col-lg-8">
                        <!-- Work Order Details Card -->
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-info-circle me-2"></i>Work Order Information
                                    {% if repair_work_order.RushOrder %}
                                        <span class="badge bg-warning text-dark ms-2"><i class="fas fa-bolt me-1"></i>Rush</span>
                                    {% endif %}
                                    {% if repair_work_order.FirmRush %}
                                        <span class="badge bg-danger ms-2"><i class="fas fa-exclamation-triangle me-1"></i>Firm Rush</span>
                                    {% endif %}
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="detail-row">
                                            <div class="detail-label">Customer ID <span class="text-danger">*</span></div>
                                            <div class="detail-value">
                                                <input type="text" class="form-control" name="CustID" value="{{ repair_work_order.CustID or '' }}" required>
                                            </div>
                                        </div>
                                        <div class="detail-row">
                                            <div class="detail-label">Work Order Number</div>
                                            <div class="detail-value">
                                                <input type="text" class="form-control" value="R{{ repair_work_order.RepairOrderNo }}" readonly>
                                            </div>
                                        </div>
                                        <div class="detail-row">
                                            <div class="detail-label">RO Name</div>
                                            <div class="detail-value">
                                                <input type="text" class="form-control" name="ROName" value="{{ repair_work_order.ROName or '' }}">
                                            </div>
                                        </div>
                                        <div class="detail-row">
                                            <div class="detail-label">Storage Time</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-clock"></i>
                                                    </span>
                                                    <select class="form-select" name="STORAGE">
                                                        <option value="">Select storage duration</option>
                                                        <option value="SEASONAL" {% if repair_work_order.STORAGE == 'SEASONAL' %}selected{% endif %}>Seasonal</option>
                                                        <option value="TEMPORARY" {% if repair_work_order.STORAGE == 'TEMPORARY' %}selected{% endif %}>Temporary</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">Location / Rack #</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-map-marker-alt"></i>
                                                    </span>
                                                    <input type="text" class="form-control" name="RackNo"
                                                           value="{{ repair_work_order.RackNo or '' }}"
                                                           placeholder="e.g., hang 4, 6D, 1 D">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">Final Location</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-flag-checkered"></i>
                                                    </span>
                                                    <input type="text" class="form-control" name="final_location"
                                                           value="{{ repair_work_order.final_location or '' }}"
                                                           placeholder="Final location after repair">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="detail-row">
                                            <div class="detail-label">Date Required</div>
                                            <div class="detail-value">
                                                <input type="date" class="form-control" name="DateRequired" value="{{ repair_work_order.DateRequired or '' }}">
                                            </div>
                                        </div>
                                        <div class="detail-row">
                                            <div class="detail-label">Date Completed</div>
                                            <div class="detail-value">
                                                <input type="date" class="form-control" name="DateCompleted" value="{{ repair_work_order.DateCompleted or '' }}">
                                            </div>
                                        </div>
                                        <div class="detail-row">
                                            <div class="detail-label">Source</div>
                                            <div class="detail-value">
                                                <select class="form-select" name="SOURCE">
                                                    <option value="">Select Source</option>
                                                    {% for source in sources %}
                                                    <option value="{{ source.SSource }}" {% if repair_work_order.SOURCE == source.SSource %}selected{% endif %}>{{ source.SSource }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="detail-row">
                                            <div class="detail-label">Priority Options</div>
                                            <div class="detail-value">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="RushOrder" name="RushOrder" value="1" {% if repair_work_order.RushOrder %}checked{% endif %}>
                                                    <label class="form-check-label" for="RushOrder">
                                                        <span class="badge bg-warning text-dark"><i class="fas fa-bolt me-1"></i>Rush Order</span>
                                                    </label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="FirmRush" name="FirmRush" value="1" {% if repair_work_order.FirmRush %}checked{% endif %}>
                                                    <label class="form-check-label" for="FirmRush">
                                                        <span class="badge bg-danger"><i class="fas fa-exclamation-triangle me-1"></i>Firm Rush</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="detail-row">
                                            <div class="detail-label">Customer Price</div>
                                            <div class="detail-value">
                                                <input type="number" step="0.01" class="form-control" name="CUSTOMERPRICE" value="{{ repair_work_order.CUSTOMERPRICE or '' }}">
                                            </div>
                                        </div>
                                        <div class="detail-row">
                                            <div class="detail-label">Return Method</div>
                                            <div class="detail-value">
                                                <select class="form-select" name="RETURNSTATUS">
                                                    <option value="">Select return method</option>
                                                    <option value="SHIP" {% if repair_work_order.RETURNSTATUS == 'SHIP' %}selected{% endif %}>Ship</option>
                                                    <option value="PICKUP" {% if repair_work_order.RETURNSTATUS == 'PICKUP' %}selected{% endif %}>Pickup</option>
                                                    <option value="DELIVERY" {% if repair_work_order.RETURNSTATUS == 'DELIVERY' %}selected{% endif %}>Delivery</option>
                                                </select>
                                                <small class="form-text text-muted">How the item will be returned to customer</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="detail-row">
                                            <div class="detail-label">
                                                <i class="fas fa-clipboard-list me-1"></i>Special Instructions
                                            </div>
                                            <div class="detail-value">
                                                <textarea class="form-control" name="SPECIALINSTRUCTIONS" rows="3" 
                                                          placeholder="Enter any special instructions or notes for this repair work order..."
                                                          >{{ repair_work_order.SPECIALINSTRUCTIONS or '' }}</textarea>
                                                <small class="form-text text-muted">Provide detailed instructions for the repair team</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Existing Items Card -->
                        {% if repair_work_order.items %}
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-list me-2"></i>Existing Items
                                    <span class="badge bg-secondary ms-2" id="existing-items-count">{{ repair_work_order.items|length }}</span>
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="existing-items-container">
                                    {% for item in repair_work_order.items %}
                                    <div class="item-row" data-item-index="{{ loop.index0 }}">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="form-label">Description</label>
                                                <input type="text" class="form-control" name="existing_description[]" value="{{ item.Description or '' }}" required>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">Material</label>
                                                <input type="text" class="form-control" name="existing_material[]" value="{{ item.Material or '' }}">
                                            </div>
                                            <div class="col-md-1">
                                                <label class="form-label">Qty</label>
                                                <input type="number" class="form-control qty-input" name="existing_qty[]" value="{{ item.Qty or '1' }}" min="1">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">Condition</label>
                                                <input type="text" class="form-control" name="existing_condition[]" value="{{ item.Condition or '' }}" list="condition-list">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">Color</label>
                                                <input type="text" class="form-control" name="existing_color[]" value="{{ item.Color or '' }}">
                                            </div>
                                            <div class="col-md-1">
                                                <label class="form-label">Actions</label>
                                                <div>
                                                    <button type="button" class="btn btn-danger btn-sm" onclick="removeExistingItem(this)">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-md-4">
                                                <label class="form-label">Size/Weight</label>
                                                <input type="text" class="form-control" name="existing_size[]" value="{{ item.SizeWgt or '' }}">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Price</label>
                                                <input type="number" step="0.01" class="form-control" name="existing_price[]" value="{{ item.Price or '' }}">
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Customer Inventory -->
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-boxes me-2"></i>Customer Item History
                                    <span class="badge bg-secondary ms-2" id="inventory-count">0</span>
                                </h5>
                                <small class="text-muted">Items from previous work orders for this customer</small>
                            </div>
                            <div class="card-body">
                                <div id="customer-inventory">
                                    <div class="inventory-empty">
                                        <i class="fas fa-boxes"></i>
                                        <p>Loading customer inventory...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Add New Items Card -->
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-plus me-2"></i>Add New Items
                                    <span class="badge bg-success ms-2" id="new-items-count">0</span>
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="new-items-container"></div>
                                <button type="button" class="btn btn-add-item" onclick="addNewItem()">
                                    <i class="fas fa-plus me-2"></i>Add New Item
                                </button>
                            </div>
                        </div>

                        <!-- File Upload -->
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-cloud-upload-alt me-2"></i>Upload Files
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="card mb-3" id="fileDropzone" style="cursor: pointer;">
                                    <div class="card-body text-center">
                                        <p class="card-text">Drag & drop files here, or click to select</p>
                                        <small class="text-muted">Supported: PDF, JPG, PNG, DOCX, XLSX, TXT, CSV (Max 10MB each)</small>

                                        <input type="file" name="files[]" id="files" multiple
                                            accept=".pdf,.jpg,.jpeg,.png,.docx,.xlsx,.txt,.csv"
                                            style="display: none;">

                                        <div class="mt-3" id="fileListContainer" style="display: none;">
                                            <h6>Selected Files:</h6>
                                            <ul class="list-group list-group-flush" id="fileList"></ul>
                                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="clearFiles()">
                                                <i class="fas fa-trash me-1"></i>Clear All
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <!-- Order Summary -->
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header">
                                <h5 class="card-title mb-0"><i class="fas fa-chart-bar me-2"></i>Order Summary</h5>
                            </div>
                            <div class="card-body">
                                <div class="detail-row">
                                    <div class="detail-label">Existing Items</div>
                                    <div class="detail-value">
                                        <span class="badge bg-success" id="summary-existing">{{ repair_work_order.items|length if repair_work_order.items else 0 }}</span>
                                    </div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">Items to Delete</div>
                                    <div class="detail-value">
                                        <span class="badge bg-danger" id="summary-delete">0</span>
                                    </div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">Selected Items</div>
                                    <div class="detail-value">
                                        <span class="badge bg-primary" id="selected-count">0</span>
                                    </div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">New Items</div>
                                    <div class="detail-value">
                                        <span class="badge bg-info" id="summary-new">0</span>
                                    </div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">Total Items</div>
                                    <div class="detail-value">
                                        <span class="badge bg-dark" id="total-count">{{ repair_work_order.items|length if repair_work_order.items else 0 }}</span>
                                    </div>
                                </div>
                                <div class="detail-row" id="rush-status">
                                    <div class="detail-label">Priority</div>
                                    <div class="detail-value">
                                        <span class="badge bg-warning text-dark" id="rush-badge" {% if repair_work_order.RushOrder != "YES" %}style="display: none;"{% endif %}>
                                            <i class="fas fa-bolt me-1"></i>Rush Order
                                        </span>
                                        <span class="badge bg-danger" id="firm-rush-badge" {% if repair_work_order.FirmRush != "YES" %}style="display: none;"{% endif %}>
                                            <i class="fas fa-exclamation-triangle me-1"></i>Firm Rush
                                        </span>
                                    </div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">Status</div>
                                    <div class="detail-value">
                                        {% if repair_work_order.DateCompleted %}
                                            <span class="badge bg-success"><i class="fas fa-check me-1"></i>Completed</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>Pending</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="card shadow-sm">
                            <div class="card-header">
                                <h5 class="card-title mb-0"><i class="fas fa-cogs me-2"></i>Actions</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-save me-2"></i>Update Work Order
                                    </button>
                                    <a href="{{ url_for('repair_work_orders.view_repair_work_order', repair_order_no=repair_work_order.RepairOrderNo) }}" class="btn btn-outline-secondary">
                                        <i class="fas fa-times me-2"></i>Cancel Changes
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let newItemCounter = 0;
let newItemsCount = 0;
let deletedItemsCount = 0;
let selectedItemsCount = 0;
let existingItemsCount = {{ repair_work_order.items|length if repair_work_order.items else 0 }};

function formatPrice(price) {
    let num = parseFloat(price);
    if (isNaN(num)) return "$0.00";
    return `$${num.toFixed(2)}`;
}

function loadCustomerInventory(custId) {
    const inventoryContainer = document.getElementById('customer-inventory');

    if (!custId) {
        inventoryContainer.innerHTML = `
            <div class="inventory-empty">
                <i class="fas fa-boxes"></i>
                <p>Select a customer to view their inventory items</p>
            </div>
        `;
        updateInventoryCount(0);
        return;
    }

    // Show loading
    inventoryContainer.innerHTML = `
        <div class="inventory-empty">
            <div class="spinner-border text-primary loading-spinner" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading inventory items...</p>
        </div>
    `;

    fetch(`/work_orders/api/customer_inventory/${custId}`)
        .then(response => response.json())
        .then(data => {
            updateInventoryCount(data.length);

            if (data.length === 0) {
                inventoryContainer.innerHTML = `
                    <div class="inventory-empty">
                        <i class="fas fa-box-open"></i>
                        <p>No items found in previous work orders for this customer</p>
                        <small class="text-muted">Add new items below to get started</small>
                    </div>
                `;
                return;
            }

            let html = '';
            data.forEach(item => {
                html += `
                    <div class="inventory-item" onclick="toggleItem(this, '${item.id}')">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="selected_items[]" value="${item.id}" id="item_${item.id}">
                            <label class="form-check-label w-100" for="item_${item.id}">
                                <div class="row align-items-center">
                                    <div class="col-md-5">
                                        <div class="detail-label">${item.description}</div>
                                        <small class="text-muted">${item.material || 'No material specified'}</small>
                                    </div>
                                    <div class="col-md-3">
                                        <span class="badge bg-secondary">${item.condition || 'Unknown'}</span>
                                        <br><small class="text-muted">${item.color || 'No color'}</small>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <small class="text-muted">Size:</small><br>
                                        <small>${item.size_wgt || '-'}</small><br>
                                        <strong>${formatPrice(item.price)}</strong>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">Qty:</label>
                                        <input type="number" class="form-control form-control-sm qty-input"
                                            name="item_qty_${item.id}" value="${item.qty || 1}" min="1"
                                            onclick="event.stopPropagation()">
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                `;
            });
            inventoryContainer.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading inventory:', error);
            inventoryContainer.innerHTML = `
                <div class="inventory-empty">
                    <i class="fas fa-exclamation-triangle text-danger"></i>
                    <p class="text-danger">Error loading previous work order items</p>
                </div>
            `;
        });
}

function toggleItem(element, itemId) {
    const checkbox = element.querySelector('input[type="checkbox"]');
    if (event.target.type !== 'checkbox' && event.target.type !== 'number') {
        checkbox.checked = !checkbox.checked;
    }

    if (checkbox.checked) {
        element.classList.add('selected');
        selectedItemsCount++;
    } else {
        element.classList.remove('selected');
        selectedItemsCount--;
    }

    updateCounts();
}

function updateInventoryCount(count) {
    document.getElementById('inventory-count').textContent = count;
}

function updateCounts() {
    document.getElementById('new-items-count').textContent = newItemsCount;
    document.getElementById('summary-new').textContent = newItemsCount;
    document.getElementById('summary-delete').textContent = deletedItemsCount;
    document.getElementById('selected-count').textContent = selectedItemsCount;

    // Calculate total: existing items (minus deleted) + selected items + new items
    const activeExisting = existingItemsCount - deletedItemsCount;
    const total = activeExisting + selectedItemsCount + newItemsCount;
    document.getElementById('total-count').textContent = total;

    // Update rush badges
    const rush = document.getElementById('RushOrder').checked;
    const firmRush = document.getElementById('FirmRush').checked;
    document.getElementById('rush-badge').style.display = rush ? 'inline-block' : 'none';
    document.getElementById('firm-rush-badge').style.display = firmRush ? 'inline-block' : 'none';
}

function removeExistingItem(button) {
    // Simply remove the item row - when form submits, only remaining items are sent
    const itemRow = button.closest('.item-row');
    itemRow.remove();
    existingItemsCount--;
    updateCounts();
}

// Create datalists for autocomplete suggestions
function createDatalists() {
    // Description datalist
    const descriptionDatalist = document.createElement('datalist');
    descriptionDatalist.id = 'description-list';
    descriptionValues.forEach(val => {
        const option = document.createElement('option');
        option.value = val;
        descriptionDatalist.appendChild(option);
    });
    document.body.appendChild(descriptionDatalist);

    // Material datalist
    const materialDatalist = document.createElement('datalist');
    materialDatalist.id = 'material-list';
    materialValues.forEach(val => {
        const option = document.createElement('option');
        option.value = val;
        materialDatalist.appendChild(option);
    });
    document.body.appendChild(materialDatalist);

    // Color datalist
    const colorDatalist = document.createElement('datalist');
    colorDatalist.id = 'color-list';
    colorValues.forEach(val => {
        const option = document.createElement('option');
        option.value = val;
        colorDatalist.appendChild(option);
    });
    document.body.appendChild(colorDatalist);

    // Condition datalist
    const conditionDatalist = document.createElement('datalist');
    conditionDatalist.id = 'condition-list';
    conditionValues.forEach(val => {
        const option = document.createElement('option');
        option.value = val;
        conditionDatalist.appendChild(option);
    });
    document.body.appendChild(conditionDatalist);
}

function addNewItem() {
    newItemCounter++;
    newItemsCount++;
    updateCounts();

    const container = document.getElementById('new-items-container');
    const div = document.createElement('div');
    div.className = 'new-item-row';
    div.innerHTML = `
        <div class="mb-2"><strong>New Item #${newItemCounter}</strong></div>
        <div class="row">
            <div class="col-md-6">
                <label class="form-label">Description *</label>
                <input type="text" name="new_description[]" class="form-control" placeholder="Item Description" required list="description-list">
            </div>
            <div class="col-md-3">
                <label class="form-label">Material</label>
                <input type="text" name="new_material[]" class="form-control" placeholder="Material" list="material-list">
            </div>
            <div class="col-md-2">
                <label class="form-label">Qty</label>
                <input type="number" name="new_qty[]" class="form-control qty-input" placeholder="1" min="1" value="1" required>
            </div>
            <div class="col-md-1">
                <label class="form-label">Actions</label>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeNewItem(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-3">
                <label class="form-label">Condition</label>
                <input type="text" name="new_condition[]" class="form-control" placeholder="Condition" list="condition-list">
            </div>
            <div class="col-md-3">
                <label class="form-label">Color</label>
                <input type="text" name="new_color[]" class="form-control" placeholder="Color" list="color-list">
            </div>
            <div class="col-md-3">
                <label class="form-label">Size/Weight</label>
                <input type="text" name="new_size[]" class="form-control" placeholder="Size/Weight">
            </div>
            <div class="col-md-3">
                <label class="form-label">Price</label>
                <input type="number" step="0.01" name="new_price[]" class="form-control" placeholder="0.00">
            </div>
        </div>
    `;
    container.appendChild(div);
}

function removeNewItem(button) {
    button.closest('.new-item-row').remove();
    newItemsCount--;
    updateCounts();
}

// Initialize datalists on load
document.addEventListener('DOMContentLoaded', function() {
    createDatalists();

    // Load customer inventory on page load
    const custIdInput = document.querySelector('input[name="CustID"]');
    if (custIdInput && custIdInput.value) {
        loadCustomerInventory(custIdInput.value);
    }
});

// Update counts if priority checkboxes change
document.getElementById('RushOrder').addEventListener('change', updateCounts);
document.getElementById('FirmRush').addEventListener('change', updateCounts);

// Auto-populate source and reload inventory when customer changes
const custIdInput2 = document.querySelector('input[name="CustID"]');
if (custIdInput2) {
    custIdInput2.addEventListener('change', function() {
        const custId = this.value;
        if (custId) {
            // Load customer inventory
            loadCustomerInventory(custId);

            // Auto-populate source
            fetch(`/customers/api/customer/${custId}`)
                .then(response => response.json())
                .then(customer => {
                    const sourceSelect = document.querySelector('select[name="SOURCE"]');
                    if (customer.ShipTo && sourceSelect) {
                        sourceSelect.value = customer.ShipTo;
                    }
                })
                .catch(error => {
                    console.error('Error loading customer data:', error);
                });
        }
    });
}

// Form validation
document.getElementById('editOrderForm').addEventListener('submit', function(e) {
    const custId = document.querySelector('input[name="CustID"]').value;
    if (!custId.trim()) {
        e.preventDefault();
        alert('Customer ID is required');
        return;
    }
    
    // Check if any new items have descriptions
    const newDescriptions = document.querySelectorAll('input[name="new_description[]"]');
    let hasValidNewItems = true;
    newDescriptions.forEach(input => {
        if (input.value.trim() === '') {
            hasValidNewItems = false;
        }
    });
    
    if (newDescriptions.length > 0 && !hasValidNewItems) {
        e.preventDefault();
        alert('Please fill in descriptions for all new items or remove empty items');
        return;
    }
});

// Initialize counts on load
updateCounts();

// File upload handling
const dropzone = document.getElementById('fileDropzone');
const fileInput = document.getElementById('files');
const fileList = document.getElementById('fileList');
const fileListContainer = document.getElementById('fileListContainer');

const ALLOWED_EXTENSIONS = ['pdf', 'jpg', 'jpeg', 'png', 'docx', 'xlsx', 'txt', 'csv'];
const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

function validateFile(file) {
    const extension = file.name.split('.').pop().toLowerCase();
    if (!ALLOWED_EXTENSIONS.includes(extension)) {
        alert(`File type not allowed: ${file.name}\nAllowed types: ${ALLOWED_EXTENSIONS.join(', ')}`);
        return false;
    }
    if (file.size > MAX_FILE_SIZE) {
        alert(`File too large: ${file.name}\nMaximum size: 10MB`);
        return false;
    }
    return true;
}

dropzone.addEventListener('click', (e) => {
    if (e.target.tagName !== 'BUTTON') {
        fileInput.click();
    }
});

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropzone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
    }, false);
});

['dragenter', 'dragover'].forEach(eventName => {
    dropzone.addEventListener(eventName, () => {
        dropzone.classList.add('border-primary', 'border-2', 'bg-light');
    }, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropzone.addEventListener(eventName, () => {
        dropzone.classList.remove('border-primary', 'border-2', 'bg-light');
    }, false);
});

dropzone.addEventListener('drop', (e) => {
    const dt = e.dataTransfer;
    const files = dt.files;
    const validFiles = [];
    for (let i = 0; i < files.length; i++) {
        if (validateFile(files[i])) {
            validFiles.push(files[i]);
        }
    }
    if (validFiles.length > 0) {
        const dataTransfer = new DataTransfer();
        validFiles.forEach(file => dataTransfer.items.add(file));
        fileInput.files = dataTransfer.files;
        updateFileList();
    }
}, false);

fileInput.addEventListener('change', () => {
    const validFiles = [];
    for (let i = 0; i < fileInput.files.length; i++) {
        if (validateFile(fileInput.files[i])) {
            validFiles.push(fileInput.files[i]);
        }
    }
    if (validFiles.length !== fileInput.files.length) {
        const dataTransfer = new DataTransfer();
        validFiles.forEach(file => dataTransfer.items.add(file));
        fileInput.files = dataTransfer.files;
    }
    updateFileList();
});

function updateFileList() {
    const files = fileInput.files;
    if (files.length === 0) {
        fileListContainer.style.display = 'none';
        return;
    }
    fileListContainer.style.display = 'block';
    fileList.innerHTML = '';
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        const fileInfo = document.createElement('div');
        fileInfo.innerHTML = `
            <i class="fas fa-file me-2"></i>
            <strong>${file.name}</strong>
            <small class="text-muted ms-2">(${formatFileSize(file.size)})</small>
        `;
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-sm btn-outline-danger';
        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
        removeBtn.onclick = () => removeFile(i);
        li.appendChild(fileInfo);
        li.appendChild(removeBtn);
        fileList.appendChild(li);
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function removeFile(index) {
    const files = Array.from(fileInput.files);
    files.splice(index, 1);
    const dataTransfer = new DataTransfer();
    files.forEach(file => dataTransfer.items.add(file));
    fileInput.files = dataTransfer.files;
    updateFileList();
}

function clearFiles() {
    fileInput.value = '';
    updateFileList();
}
</script>
{% endblock %}