{% extends "base.html" %}
{% from "_order_macros.html" import
    customer_inventory_section,
    file_upload_section,
    new_items_section_cards,
    order_summary_sidebar
%}

{% block title %}Edit Repair Work Order #{{ repair_work_order.RepairOrderNo }}{% endblock %}

{% block styles %}
{{ super() }}
<style>
.existing-item-card {
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}
.existing-item-card.marked-for-deletion {
    background-color: var(--bs-danger-bg-subtle);
    border-color: var(--bs-danger-border-subtle);
    opacity: 0.7;
}
.new-item-row {
    background-color: var(--bs-info-bg-subtle);
    border: 1px solid var(--bs-info-border-subtle);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}
.text-strike {
    text-decoration: line-through;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3"><i class="fas fa-edit me-2"></i>Edit Repair Work Order #R{{ repair_work_order.RepairOrderNo }}</h1>
                    <p class="text-muted mb-0">Modify work order details and manage items</p>
                </div>
                <div>
                    <a href="{{ url_for('repair_work_orders.view_repair_work_order', repair_order_no=repair_work_order.RepairOrderNo) }}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-eye me-1"></i>View Order
                    </a>
                    <a href="{{ url_for('repair_work_orders.list_repair_work_orders') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to List
                    </a>
                </div>
            </div>

            <form method="POST" id="repairOrderForm" enctype="multipart/form-data">
                <div class="row">
                    <div class="col-lg-8">
                        <!-- Order Information Card -->
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-info-circle me-2"></i>Order Information
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="detail-row">
                                            <div class="detail-label">Customer ID <span class="text-danger">*</span></div>
                                            <div class="detail-value">
                                                <input type="text" class="form-control" id="CustID" name="CustID" required
                                                       value="{{ repair_work_order.CustID }}">
                                            </div>
                                        </div>
                                        <div class="detail-row">
                                            <div class="detail-label">Order Number</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-hashtag"></i>
                                                    </span>
                                                    <input type="text" class="form-control" value="RO-{{ repair_work_order.RepairOrderNo }}" readonly>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="detail-row">
                                            <div class="detail-label">Order Name</div>
                                            <div class="detail-value">
                                                <input type="text" class="form-control" name="ROName"
                                                       value="{{ repair_work_order.ROName or '' }}">
                                            </div>
                                        </div>
                                        <div class="detail-row">
                                            <div class="detail-label">Source</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-shipping-fast"></i>
                                                    </span>
                                                    <input type="text" class="form-control" id="SOURCE" name="SOURCE" readonly
                                                           value="{{ repair_work_order.SOURCE or '' }}"
                                                           placeholder="Auto-selected from customer">
                                                </div>
                                                <small class="form-text text-muted">Automatically populated from customer record (cannot be changed)</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="detail-row">
                                            <div class="detail-label">Date In</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-calendar-alt"></i>
                                                    </span>
                                                    <input type="date" class="form-control" name="DateIn"
                                                           value="{{ repair_work_order.DateIn.strftime('%Y-%m-%d') if repair_work_order.DateIn else '' }}" autofocus>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="detail-row">
                                            <div class="detail-label">Date Required</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-calendar-check"></i>
                                                    </span>
                                                    <input type="date" class="form-control" name="DateRequired"
                                                           value="{{ repair_work_order.DateRequired.strftime('%Y-%m-%d') if repair_work_order.DateRequired else '' }}">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="detail-row">
                                            <div class="detail-label">Date to Sub</div>
                                            <div class="detail-value">
                                                <input type="date" class="form-control" name="DATE_TO_SUB"
                                                       value="{{ repair_work_order.DATE_TO_SUB.strftime('%Y-%m-%d') if repair_work_order.DATE_TO_SUB else '' }}">
                                            </div>
                                        </div>
                                        <div class="detail-row">
                                            <div class="detail-label">Date Ret. from Sub.</div>
                                            <div class="detail-value">
                                                <input type="date" class="form-control" name="RETURNDATE"
                                                       value="{{ repair_work_order.RETURNDATE.strftime('%Y-%m-%d') if repair_work_order.RETURNDATE else '' }}">
                                            </div>
                                        </div>
                                        <div class="detail-row">
                                            <div class="detail-label">Date Completed</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-check-circle"></i>
                                                    </span>
                                                    <input type="date" class="form-control" name="DateCompleted"
                                                           value="{{ repair_work_order.DateCompleted.strftime('%Y-%m-%d') if repair_work_order.DateCompleted else '' }}">

                                                </div>
                                            </div>
                                        </div>
                                        <div class="detail-row">
                                            <div class="detail-label">Priority Options</div>
                                            <div class="detail-value">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="RushOrder" name="RushOrder" value="1"
                                                           {% if repair_work_order.RushOrder %}checked{% endif %}>
                                                    <label class="form-check-label" for="RushOrder">
                                                        <span class="badge bg-warning text-dark">
                                                            <i class="fas fa-bolt me-1"></i>Rush Order
                                                        </span>
                                                    </label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="FirmRush" name="FirmRush" value="1"
                                                           {% if repair_work_order.FirmRush %}checked{% endif %}>
                                                    <label class="form-check-label" for="FirmRush">
                                                        <span class="badge bg-danger">
                                                            <i class="fas fa-exclamation-triangle me-1"></i>Firm Rush
                                                        </span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="detail-row">
                                            <div class="detail-label">Return To</div>
                                            <div class="detail-value">
                                                <select class="form-select" name="RETURNTO">
                                                    <option value="">-- Select --</option>
                                                    <option value="Source" {% if repair_work_order.RETURNTO == 'Source' %}selected{% endif %}>Source</option>
                                                    <option value="Customer" {% if repair_work_order.RETURNTO == 'Customer' %}selected{% endif %}>Customer</option>
                                                    <option value="Other" {% if repair_work_order.RETURNTO == 'Other' %}selected{% endif %}>Other</option>
                                                </select>
                                                <small class="form-text text-muted">Where the package will be returned to</small>
                                            </div>
                                        </div>
                                        <div class="detail-row">
                                            <div class="detail-label">Return Method</div>
                                            <div class="detail-value">
                                                <select class="form-select" name="RETURNSTATUS">
                                                    <option value="">Select return method</option>
                                                    <option value="SHIP" {% if repair_work_order.RETURNSTATUS == 'SHIP' %}selected{% endif %}>Ship</option>
                                                    <option value="PICKUP" {% if repair_work_order.RETURNSTATUS == 'PICKUP' %}selected{% endif %}>Pickup</option>
                                                    <option value="DELIVERY" {% if repair_work_order.RETURNSTATUS == 'DELIVERY' %}selected{% endif %}>Delivery</option>
                                                    <option value="REHANG" {% if repair_work_order.RETURNSTATUS == 'REHANG' %}selected{% endif %}>Re-Hang</option>
                                                    <option value="UNKNOWN" {% if repair_work_order.RETURNSTATUS == 'UNKNOWN' %}selected{% endif %}>Unknown</option>
                                                </select>
                                                <small class="form-text text-muted">How the item will be returned to customer</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Repair Details Card -->
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-clipboard-list me-2"></i>Repair Details
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- Special Instructions -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="detail-row">
                                            <div class="detail-label">
                                                <i class="fas fa-exclamation-circle text-warning me-1"></i>Special Instructions
                                            </div>
                                            <div class="detail-value">
                                                <textarea class="form-control" name="SPECIALINSTRUCTIONS" rows="3"
                                                          placeholder="Enter any special instructions or notes for this repair work order..."
                                                          >{{ repair_work_order.SPECIALINSTRUCTIONS or '' }}</textarea>
                                                <small class="form-text text-muted">Provide detailed instructions for the repair team</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Material List -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="detail-row">
                                            <div class="detail-label">
                                                <i class="fas fa-list text-primary me-1"></i>Material List
                                            </div>
                                            <div class="detail-value">
                                                <textarea class="form-control" name="MaterialList" rows="3"
                                                          placeholder="List materials needed for this repair..."
                                                          >{{ repair_work_order.MaterialList or '' }}</textarea>
                                                <small class="form-text text-muted">Materials and supplies required for the repair</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-scissors text-secondary me-1"></i>Repair Information:</h6>

                                        <div class="detail-row">
                                            <div class="detail-label">Repairs Done By</div>
                                            <div class="detail-value">
                                                <input type="text" class="form-control" name="REPAIRSDONEBY"
                                                       value="{{ repair_work_order.REPAIRSDONEBY or '' }}"
                                                       placeholder="Enter technician name">
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">Clean</div>
                                            <div class="detail-value">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="CLEAN" name="CLEAN" value="YES"
                                                           {% if repair_work_order.CLEAN == 'YES' %}checked{% endif %}>
                                                    <label class="form-check-label" for="CLEAN">
                                                        Clean before repair
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">See Clean (WO #)</div>
                                            <div class="detail-value">
                                                <input type="text" class="form-control" name="SEECLEAN"
                                                       value="{{ repair_work_order.SEECLEAN|string|replace('.0','') or '' }}"
                                                       placeholder="Enter work order number">
                                                <small class="form-text text-muted">Reference to cleaning work order</small>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <h6><i class="fas fa-map-marker-alt text-secondary me-1"></i>Location & Storage:</h6>

                                        <div class="detail-row">
                                            <div class="detail-label">Location / Rack #</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-map-marker-alt"></i>
                                                    </span>
                                                    <input type="text" class="form-control" name="RackNo"
                                                           value="{{ repair_work_order.RackNo or '' }}"
                                                           placeholder="e.g., hang 4, 6D, 1 D">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">Storage Time</div>
                                            <div class="detail-value">
                                                <div class="input-group">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-clock"></i>
                                                    </span>
                                                    <select class="form-select" name="STORAGE">
                                                        <option value="">Select storage duration</option>
                                                        <option value="SEASONAL" {{ 'selected' if repair_work_order.STORAGE == 'SEASONAL' else '' }}>Seasonal</option>
                                                        <option value="TEMPORARY" {{ 'selected' if repair_work_order.STORAGE == 'TEMPORARY' else '' }}>Temporary</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="detail-row">
                                            <div class="detail-label">Final Location</div>
                                            <div class="detail-value">
                                                <input type="text" class="form-control" name="final_location"
                                                       value="{{ repair_work_order.final_location or '' }}"
                                                       placeholder="Final location after repair">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Existing Items Card -->
                        {% if repair_work_order.items %}
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-boxes me-2"></i>Existing Items
                                    <span class="badge bg-success ms-2" id="existing-items-count">{{ repair_work_order.items|length }}</span>
                                </h5>
                                <small class="text-muted">Click delete button to remove items from the order</small>
                            </div>
                            <div class="card-body">
                                <div id="existing-items-container">
                                    {% for item in repair_work_order.items %}
                                    <div class="existing-item-card mb-3" id="existing-item-{{ loop.index0 }}" data-inventory-key="{{ item.InventoryKey or '' }}">
                                        <input type="hidden" name="existing_item_inventory_key[]" value="{{ item.InventoryKey or '' }}">
                                        <div class="row align-items-center">
                                            <div class="col-md-3">
                                                <label class="form-label small">Description *</label>
                                                <input type="text" class="form-control form-control-sm" name="existing_description[]" value="{{ item.Description or '' }}" required list="description-list">
                                                <label class="form-label small mt-2">Material</label>
                                                <input type="text" class="form-control form-control-sm" name="existing_material[]" value="{{ item.Material or '' }}" list="material-list">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label small">Condition</label>
                                                <input type="text" class="form-control form-control-sm" name="existing_condition[]" value="{{ item.Condition or '' }}" list="condition-list">
                                                <label class="form-label small mt-2">Color</label>
                                                <input type="text" class="form-control form-control-sm" name="existing_color[]" value="{{ item.Color or '' }}" list="color-list">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label small">Size/Weight</label>
                                                <input type="text" class="form-control form-control-sm" name="existing_size[]" value="{{ item.SizeWgt or '' }}">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label small">Price</label>
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text">$</span>
                                                    <input type="number" class="form-control form-control-sm" name="existing_price[]" value="{{ item.Price or '' }}" step="0.01" min="0">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label small">Quantity</label>
                                                <input type="number" class="form-control form-control-sm" name="existing_qty[]" value="{{ item.Qty or '1' }}" min="1">
                                            </div>
                                            <div class="col-md-1 text-center">
                                                <label class="form-label small d-block">&nbsp;</label>
                                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeExistingItem({{ loop.index0 }})" title="Remove item">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Customer Inventory - SHARED MACRO -->
                        {{ customer_inventory_section() }}

                        <!-- New Items - SHARED MACRO -->
                        {{ new_items_section_cards(title="Add New Items") }}

                        <!-- File Upload - SHARED MACRO -->
                        {{ file_upload_section() }}
                    </div>

                    <div class="col-lg-4">
                        <!-- Quote & Pricing -->
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-dollar-sign me-2"></i>Quote & Pricing
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="detail-row">
                                    <div class="detail-label">Quote Status</div>
                                    <div class="detail-value">
                                        <select class="form-select" name="QUOTE">
                                            <option value="">No Quote</option>
                                            <option value="YES" {% if repair_work_order.QUOTE == 'YES' %}selected{% endif %}>Yes</option>
                                            <option value="DONE" {% if repair_work_order.QUOTE == 'DONE' %}selected{% endif %}>Done</option>
                                            <option value="APPROVED" {% if repair_work_order.QUOTE == 'APPROVED' %}selected{% endif %}>Approved</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="detail-row">
                                    <div class="detail-label">Customer Price</div>
                                    <div class="detail-value">
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" step="0.01" class="form-control" name="CUSTOMERPRICE"
                                                   value="{{ repair_work_order.CUSTOMERPRICE or '' }}"
                                                   placeholder="0.00">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Order Summary - SHARED MACRO -->
                        {{ order_summary_sidebar() }}

                        <!-- Actions -->
                        <div class="card shadow-sm">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-cogs me-2"></i>Actions
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-save me-2"></i>Update Repair Order
                                    </button>
                                    <a href="{{ url_for('repair_work_orders.view_repair_work_order', repair_order_no=repair_work_order.RepairOrderNo) }}" class="btn btn-outline-secondary">
                                        <i class="fas fa-eye me-2"></i>View Order
                                    </a>
                                    <a href="{{ url_for('repair_work_orders.list_repair_work_orders') }}" class="btn btn-outline-secondary">
                                        <i class="fas fa-arrow-left me-2"></i>Cancel
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Include shared JavaScript -->
<script src="{{ url_for('static', filename='js/order-form-shared.js') }}"></script>

<!-- Repair-order-edit-specific JavaScript -->
<script>
// Track existing items that should be removed
let existingItemsCount = {{ repair_work_order.items|length if repair_work_order.items else 0 }};

function removeExistingItem(itemIndex) {
    const element = document.getElementById(`existing-item-${itemIndex}`);
    if (element) {
        element.remove();
        existingItemsCount--;
        document.getElementById('existing-items-count').textContent = existingItemsCount;
        updateCounts();

        // Refresh customer inventory to show removed item
        const custId = document.getElementById('CustID').value;
        if (custId) {
            loadCustomerInventory(custId);
        }

        // Show/hide empty state message
        updateExistingItemsEmptyState();
    }
}

// Show empty state message if no items remain
function updateExistingItemsEmptyState() {
    const existingItemsContainer = document.getElementById('existing-items-container');
    const remainingItems = existingItemsContainer.querySelectorAll('.existing-item-card').length;

    // Remove existing empty state if present
    const existingEmptyState = existingItemsContainer.querySelector('.empty-state-message');
    if (existingEmptyState) {
        existingEmptyState.remove();
    }

    // Add empty state if no items remain
    if (remainingItems === 0) {
        const emptyStateHtml = `
            <div class="empty-state-message text-center py-4">
                <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                <p class="text-muted">No items currently in this order</p>
                <small class="text-muted">Select items from Customer Item History below to add them</small>
            </div>
        `;
        existingItemsContainer.insertAdjacentHTML('beforeend', emptyStateHtml);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize shared components
    createDatalists();
    initializeFileUpload();

    // Customer change handler
    document.getElementById('CustID').addEventListener('change', function() {
        const custId = this.value;
        loadCustomerInventory(custId);

        // Load customer source
        if (custId) {
            fetch(`/customers/api/customer/${custId}`)
                .then(response => response.json())
                .then(customer => {
                    const sourceInput = document.getElementById('SOURCE');
                    if (customer.Source && sourceInput) {
                        sourceInput.value = customer.Source;
                    }
                })
                .catch(error => {
                    console.error('Error loading customer data:', error);
                });
        }
    });

    // Load customer inventory on page load
    const custId = document.getElementById('CustID').value;
    if (custId) {
        loadCustomerInventory(custId);
    }

    // Rush order change handlers
    document.getElementById('RushOrder').addEventListener('change', updateRushStatus);
    document.getElementById('FirmRush').addEventListener('change', updateRushStatus);

    // Form validation
    document.getElementById('repairOrderForm').addEventListener('submit', function(e) {
        const custId = document.getElementById('CustID').value;
        if (!custId) {
            e.preventDefault();
            alert('Please select a customer.');
            document.getElementById('CustID').focus();
            return;
        }

        // Check if at least one item exists or is added
        const selectedItems = document.querySelectorAll('input[name="selected_items[]"]:checked').length;
        const newItems = document.querySelectorAll('input[name="new_item_description[]"]').length;
        const existingItems = document.querySelectorAll('input[name="existing_description[]"]').length;

        if (selectedItems === 0 && newItems === 0 && existingItems === 0) {
            e.preventDefault();
            alert('Please keep at least one existing item, select an inventory item, or add a new item.');
            return;
        }

        // Validate all item descriptions
        const allDescriptions = document.querySelectorAll('input[name="new_item_description[]"], input[name="existing_description[]"]');
        let hasEmptyDescription = false;
        allDescriptions.forEach(input => {
            if (!input.value.trim()) {
                hasEmptyDescription = true;
                input.focus();
            }
        });

        if (hasEmptyDescription) {
            e.preventDefault();
            alert('Please provide descriptions for all items.');
            return;
        }

        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
        submitBtn.disabled = true;

        // Re-enable button after 10 seconds in case of issues
        setTimeout(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }, 10000);
    });

    // Initialize counts and rush status
    updateCounts();
    updateRushStatus();
});
</script>
{% endblock %}
