{% extends "base.html" %}

{% block title %}Repair Work Orders{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">Repair Work Orders</h1>
        {% if current_user.role != 'user' %}
        <a href="{{ url_for('repair_work_orders.create_repair_order') }}" class="btn btn-primary btn-sm">
            <i class="fas fa-plus me-1"></i> Add Repair Order
        </a>
        {% endif %}
    </div>

    <!-- Status Filters -->
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <div class="btn-group btn-group-sm" role="group">
            <button id="btn-all" class="btn btn-outline-secondary active">All</button>
            <button id="btn-pending" class="btn btn-outline-warning">Pending</button>
            <button id="btn-rush" class="btn btn-outline-danger">Rush</button>
            <button id="btn-completed" class="btn btn-outline-success">Completed</button>
        </div>
        <small class="text-muted" id="total-repair-orders">Loading...</small>
    </div>

    <!-- Table Container -->
    <div class="bg-white rounded-3 shadow-sm border-0">
        <div class="d-flex justify-content-end p-2">
            <button id="clear-table-filters-btn" class="btn btn-outline-warning btn-sm me-2">
                <i class="fas fa-filter-circle-xmark me-1"></i> Clear Filters
            </button>
            <button id="print-table" class="btn btn-outline-secondary btn-sm me-2">
                <i class="fas fa-print me-1"></i> Print
            </button>
            <button id="download-csv" class="btn btn-outline-success btn-sm">
                <i class="fas fa-file-csv me-1"></i> Export CSV
            </button>
        </div>
        <div id="repair-orders-table"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator_bootstrap5.min.css" rel="stylesheet">
<script src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>

<script>

  // Add this function to your JavaScript file
function dateSorter(a, b, aRow, bRow, column, dir, sorterParams) {
    const dateA = new Date(a);
    const dateB = new Date(b);

    const timeA = dateA.getTime();
    const timeB = dateB.getTime();

    // Handle invalid dates
    if (isNaN(timeA) && isNaN(timeB)) return 0;
    if (isNaN(timeA)) return -1;
    if (isNaN(timeB)) return 1;

    // Sort based on timestamps
    return timeA - timeB;
}


/**
 * Formats a date object or a date string into MM/DD/YYYY format.
 * @param {string|Date} dateValue The date to format.
 * @returns {string} The formatted date string, or an empty string if invalid.
 */
 function formatDate(dateValue) {
    if (!dateValue) {
        return '';
    }

    try {
        const date = new Date(dateValue);

        // Check if the date is a valid date object
        if (isNaN(date.getTime())) {
            return '';
        }

        // Intl.DateTimeFormat is the modern way to handle date formatting
        // It provides better reusability and handles locale-specific formatting
        const formatter = new Intl.DateTimeFormat('en-US', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });

        return formatter.format(date);
    } catch (e) {
        console.error("Failed to format date:", e);
        return '';
    }
}

document.addEventListener("DOMContentLoaded", function() {
    let currentStatus = "";

    const table = window.repairOrdersTable = new Tabulator("#repair-orders-table", {
        ajaxURL: "{{ url_for('repair_work_orders.api_repair_work_orders') | safe }}",
        ajaxParams: function() {
            // Consolidate all filter parameters here
            const params = {
                status: currentStatus
            };

            // Add column header filters to the request
            table.getHeaderFilters().forEach(filter => {
                if(filter.value) params[`filter_${filter.field}`] = filter.value;
            });

            return params;
        },
        pagination: true,
        paginationMode: "remote",
        paginationSize: 25,
        paginationSizeSelector: [10, 25, 50, 100, 250, 500],
        layout: "fitColumns",
        filterMode: "remote",
        sortMode: "remote",
        multiSort: true,

        persistence: {
            sort: true, // persist column sorting
            headerFilter: true, // persist header filters  
            page: true, // persist current page and page size
        },
        
        // Use a unique ID for this table's persistence
        persistenceID: "repair_table",

        columns: [
            {
                title: "Order #", field: "RepairOrderNo", width: 167, headerFilter: "input",
                formatter: (cell) => {
                    const rowData = cell.getRow().getData();
                    let rushBadge = rowData.is_rush ? ' <span class="badge bg-danger ms-1">RUSH</span>' : '';
                    return `<span class="badge bg-warning text-dark">
                        <i class="fas fa-hashtag me-1"></i>
                        <a href="${rowData.detail_url}">R${cell.getValue()}</a></span>${rushBadge}`;
                }
            },
            {
                title: "Customer", field: "CustID", width: 120, headerFilter: "input",
                formatter: (cell) => {
                    const row = cell.getRow().getData();
                    return row.customer_url ? `<a href="${row.customer_url}" class="badge bg-info">${cell.getValue()}</a>` : `<span class="text-muted">—</span>`;
                }
            },
            { title: "Name", field: "ROName", headerFilter: "input" },
            { title: "Date In", field: "DateIn", width: 120, headerFilter: "input",
            sorter: dateSorter,
            sorterParams: {
                format: "YYYY-MM-DD" // Tabulator will parse dates in this format
            },
            formatter: (cell) => formatDate(cell.getValue())},
            { title: "Date Completed", field: "DateCompleted", width: 120, headerFilter: "input", 
            sorter: dateSorter,
            sorterParams: {
                format: "YYYY-MM-DD" // Tabulator will parse dates in this format
            },
            formatter: (cell) => formatDate(cell.getValue())},
            { title: "Source", 
            field: "Source", 
            width: 140,
            headerFilter: "input",
            sorter: "string",
              formatter: cell => cell.getValue() ? `<span class="badge bg-info">${cell.getValue()}</span>` : `<span class="text-muted">—</span>` },

            { 
                title: "Actions", field: "actions", width: 150, hozAlign: "center", headerFilter: false, headerSort: false,
                formatter: (cell) => {
                    const data = cell.getRow().getData();
                    return `
                        <div class="btn-group btn-group-sm">
                            <a href="${data.detail_url}" class="btn btn-outline-primary" title="View">
                                <i class="fas fa-eye"></i>
                            </a>
                            {% if current_user.role != 'user' %}
                            <a href="${data.edit_url}" class="btn btn-outline-warning" title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            <form method="POST" action="${data.delete_url}" style="display:inline;" 
                                onsubmit="return confirm('Are you sure you want to delete this order?');">
                                <button type="submit" class="btn btn-outline-danger" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                            {% endif %}
                        </div>`;
                },
                print:false,
            }

        ],
        ajaxResponse: function(url, params, response) {
            document.getElementById("total-repair-orders").textContent =
                response.total ? `${response.total.toLocaleString()} repair orders` : "No repair orders";
            // Tabulator expects an object with 'last_page' and 'data'
            return { last_page: response.last_page, data: response.data };
        },
        ajaxError: function(error){
            console.error("Ajax Error:", error);
            document.getElementById("total-repair-orders").textContent = "Error loading data.";
        },
    });

    table.on("tableBuilt", function() {
        // Focus the header filter for the 'ROName' column
        const roNameColumn = table.getColumn("ROName");
        if (roNameColumn) {
            roNameColumn.headerFilterFocus();
        }
    });

    // --- Event Listeners ---

    // Print & CSV Export
    document.getElementById("print-table").addEventListener("click", () => table.print(false, true));
    document.getElementById("download-csv").addEventListener("click", () => table.download("csv", "repair_orders.csv"));

    // Debounce for header filters to reduce API calls while typing
    let filterTimeout;
    table.on("headerFilterUpdated", () => {
        clearTimeout(filterTimeout);
        filterTimeout = setTimeout(() => table.setData(), 500);
    });

    // Clear table filters button (next to print/export)
    document.getElementById("clear-table-filters-btn")?.addEventListener("click", () => {
        table.clearHeaderFilter();
        table.setData();
    });

    // Status filter buttons
    const setStatus = (status, btn) => {
        currentStatus = status;
        document.querySelectorAll(".btn-group button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        table.setData(); // Reload table with the new status
    };

    document.getElementById("btn-all").addEventListener("click", e => setStatus("", e.target));
    document.getElementById("btn-pending").addEventListener("click", e => setStatus("pending", e.target));
    document.getElementById("btn-rush").addEventListener("click", e => setStatus("rush", e.target));
    document.getElementById("btn-completed").addEventListener("click", e => setStatus("completed", e.target));
});
</script>
{% endblock %}
