{% extends "base.html" %}

{% block title %}Repair Order {{ repair_work_order.RepairOrderNo }}{% endblock %}

{% block styles %}
{{ super() }}
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <!-- Header -->
      <div class="mb-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
          <div class="flex-grow-1">
            <h1 class="h3 mb-1">
              <i class="fas fa-scissors me-2"></i>
              Repair Order R{{ repair_work_order.RepairOrderNo }}
              {% if repair_work_order.RushOrder or repair_work_order.FirmRush %}
              <span class="badge bg-danger ms-2">
                <i class="fas fa-bolt me-1"></i>RUSH ORDER
              </span>
              {% endif %}
            </h1>
            <p class="text-muted mb-0">{{ repair_work_order.ROName or 'Unnamed Order' }}</p>
          </div>

          <div class="d-flex flex-wrap gap-2 w-100 w-md-auto justify-content-md-end">
            <a href="{{ url_for('repair_work_orders.view_repair_order_pdf', repair_order_no=repair_work_order.RepairOrderNo) }}"
              target="_blank"
              class="btn btn-info flex-fill flex-md-grow-0">
                <i class="fas fa-eye"></i> View PDF
            </a>

            {% if current_user.role != 'user' %}
            <a href="{{ url_for('repair_work_orders.edit_repair_order', repair_order_no=repair_work_order.RepairOrderNo) }}"
              class="btn btn-warning flex-fill flex-md-grow-0">
              <i class="fas fa-edit me-1"></i>Edit Order
            </a>

            <button type="button"
                    class="btn btn-danger flex-fill flex-md-grow-0"
                    onclick="confirmDelete('{{ repair_work_order.RepairOrderNo }}')">
              <i class="fas fa-trash me-1"></i>Delete Order
            </button>
            {% endif %}

            <a href="{{ url_for('repair_work_orders.list_repair_work_orders') }}"
              class="btn btn-outline-secondary flex-fill flex-md-grow-0">
              <i class="fas fa-arrow-left me-1"></i> Back to List
            </a>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- Main Details -->
        <div class="col-lg-8">
          <div class="card mb-4 shadow-sm">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-info-circle me-2"></i> Order Information
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="detail-row">
                    <div class="detail-label">Order Number</div>
                    <div class="detail-value">
                      <span class="badge bg-warning text-dark">
                        <i class="fas fa-hashtag me-1"></i>R{{ repair_work_order.RepairOrderNo }}
                      </span>
                    </div>
                  </div>
                  
                  <div class="detail-row">
                    <div class="detail-label">Customer</div>
                    <div class="detail-value">
                      {% if repair_work_order.customer %}
                          <a href="{{ url_for('customers.customer_detail', customer_id=repair_work_order.customer.CustID) }}"
                          class="text-decoration-none">
                              <i class="fas fa-user me-1"></i>{{ repair_work_order.customer.Name }}
                              <span class="badge bg-info ms-2">
                                  <i class="fas fa-hashtag me-1"></i>{{ repair_work_order.CustID }}
                              </span>
                          </a>
                      {% else %}
                          <span class="text-muted fst-italic">Not assigned</span>
                      {% endif %}
                    </div>
                  </div>

                  <div class="detail-row">
                    <div class="detail-label">Order Name</div>
                    <div class="detail-value">{{ repair_work_order.ROName or '<span class="text-muted">-</span>' | safe }}</div>
                  </div>
                  
                  <div class="detail-row">
                    <div class="detail-label">Source</div>
                    <div class="detail-value">
                      {% if repair_work_order.customer.source_info %}
                          <a href="{{ url_for('source.source_detail', source_name=repair_work_order.customer.source_info.SSource) }}" 
                            class="text-decoration-none">
                              <span class="badge bg-info">
                                  <i class="fas fa-shipping-fast me-1"></i>{{ repair_work_order.customer.source_info.SSource }}
                              </span>
                          </a>
                      {% else %}
                          <span class="text-muted fst-italic">Not assigned</span>
                      {% endif %}
                    </div>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="detail-row">
                    <div class="detail-label">Work Order Date</div>
                    <div class="detail-value">
                      <i class="fas fa-calendar-alt text-primary me-2"></i>
                      {{ (repair_work_order.WO_DATE | date_format) or '<span class="text-muted">-</span>' | safe }}
                    </div>
                  </div>
                  
                  <div class="detail-row">
                    <div class="detail-label">Date In</div>
                    <div class="detail-value">
                      <i class="fas fa-calendar-plus text-success me-2"></i>
                      {{ (repair_work_order.DateIn | date_format) or '<span class="text-muted">-</span>' | safe }}
                    </div>
                  </div>
                  
                  <div class="detail-row">
                    <div class="detail-label">Date Required</div>
                    <div class="detail-value">
                      <i class="fas fa-calendar-check text-danger me-2"></i>
                      {{ (repair_work_order.DateRequired | date_format) or '<span class="text-muted">-</span>' | safe }}
                      {% if repair_work_order.RushOrder or repair_work_order.FirmRush %}
                      <i class="fas fa-exclamation-triangle text-danger ms-1"></i>
                      {% endif %}
                    </div>
                  </div>
                  
                  <div class="detail-row">
                    <div class="detail-label">Date to Sub</div>
                    <div class="detail-value">
                      <i class="fas fa-calendar text-muted me-2"></i>
                      {{ (repair_work_order.DATE_TO_SUB | date_format) or '<span class="text-muted">-</span>' | safe }}
                    </div>
                  </div>
                  
                  <div class="detail-row">
                    <div class="detail-label">Date Completed</div>
                    <div class="detail-value">
                      <i class="fas fa-calendar-check text-primary me-2"></i>
                      {{ (repair_work_order.DateCompleted | date_format) or '<span class="text-muted">-</span>' | safe }}
                    </div>
                  </div>
                  
                  <div class="detail-row">
                    <div class="detail-label">Date Out</div>
                    <div class="detail-value">
                      <i class="fas fa-calendar-minus text-info me-2"></i>
                      {{ (repair_work_order.DATEOUT | date_format) or '<span class="text-muted">-</span>' | safe }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Special Instructions & Repair Details -->
          <div class="card mb-4 shadow-sm">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-clipboard-list me-2"></i> Repair Details
              </h5>
            </div>
            <div class="card-body">
              {% if repair_work_order.SPECIALINSTRUCTIONS %}
              <div class="mb-3">
                <h6><i class="fas fa-exclamation-circle text-warning me-1"></i>Special Instructions:</h6>
                <div class="alert alert-info">
                  {{ repair_work_order.SPECIALINSTRUCTIONS | nl2br }}
                </div>
              </div>
              {% endif %}
              
              {% if repair_work_order.MaterialList %}
              <div class="mb-3">
                <h6><i class="fas fa-list text-primary me-1"></i>Material List:</h6>
                <div class="bg-light p-3 rounded">
                  {{ repair_work_order.MaterialList }}
                </div>
              </div>
              {% endif %}

              <div class="row">
                <div class="col-md-6">
                  <h6><i class="fas fa-scissors text-secondary me-1"></i>Repair Information:</h6>
                  
                  <div class="detail-row">
                    <div class="detail-label">Repairs Done By</div>
                    <div class="detail-value">{{ repair_work_order.REPAIRSDONEBY or '<span class="text-muted">Not assigned</span>' | safe }}</div>
                  </div>
                  
                  <div class="detail-row">
                    <div class="detail-label">Clean</div>
                    <div class="detail-value">
                      {% if repair_work_order.CLEAN %}
                        <i class="fas fa-check-circle text-success"></i>
                      {% else %}
                        <i class="fas fa-times-circle text-danger"></i>
                      {% endif %}
                    </div>
                  </div>
                  
                  <div class="detail-row">
                    <div class="detail-label">See Clean</div>
                    <div class="detail-value">
                      {% if repair_work_order.SEECLEAN %}
                        {% set seeclean_str = repair_work_order.SEECLEAN | string %}
                        {% if seeclean_str.replace('.', '', 1).replace('-', '', 1).isdigit() %}
                          {# Numeric value - show as badge link to work order #}
                          <a href="{{ url_for('work_orders.view_work_order', work_order_no=repair_work_order.SEECLEAN|int) }}" class="text-decoration-none">
                            <span class="badge bg-primary">
                              <i class="fas fa-check me-1"></i>{{ repair_work_order.SEECLEAN | int }}
                            </span>
                          </a>
                        {% else %}
                          {# Text note - show as plain text #}
                          <span class="text-info">{{ repair_work_order.SEECLEAN }}</span>
                        {% endif %}
                      {% else %}
                        <span class="text-muted">No</span>
                      {% endif %}
                    </div>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <h6><i class="fas fa-map-marker-alt text-secondary me-1"></i>Location & Storage:</h6>

                  <div class="detail-row">
                    <div class="detail-label">Storage Time</div>
                    <div class="detail-value">
                      {% if repair_work_order.STORAGE %}
                        <span class="badge bg-info">
                          <i class="fas fa-clock me-1"></i>{{ repair_work_order.STORAGE }}
                        </span>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </div>
                  </div>

                  <div class="detail-row">
                    <div class="detail-label">Location / Rack #</div>
                    <div class="detail-value">
                      {% if repair_work_order.RackNo %}
                        <span class="badge bg-secondary">
                          <i class="fas fa-map-marker-alt me-1"></i>{{ repair_work_order.RackNo }}
                        </span>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </div>
                  </div>

                  <div class="detail-row">
                    <div class="detail-label">Final Location</div>
                    <div class="detail-value">{{ repair_work_order.final_location or '<span class="text-muted">-</span>' | safe }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Uploaded Files -->
          {% if repair_work_order.files %}
          <div class="card mb-4 shadow-sm">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-file me-2"></i> Uploaded Files
                <span class="badge bg-primary ms-2">{{ repair_work_order.files|length }}</span>
              </h5>
            </div>
            <div class="card-body p-0">
              <!-- Grid layout for file thumbnails -->
              <div class="file-grid p-3">
                {% for file in repair_work_order.files %}
                  <div class="file-item" data-file-id="{{ file.id }}">
                    <!-- Thumbnail container -->
                    <div class="file-thumbnail-container">
                      {% if file.thumbnail_path %}
                        <!-- Show actual thumbnail -->
                        <img src="{{ url_for('repair_work_orders.get_thumbnail', file_id=file.id) }}"
                          alt="{{ file.filename }}"
                          class="file-thumbnail"
                          loading="lazy"
                          onerror="this.parentElement.innerHTML='<div class=\'file-icon\'><i class=\'fas fa-file\'></i></div>'">
                      {% else %}
                        <!-- Show file type icon -->
                        <div class="file-icon">
                          {% set file_ext = file.filename.split('.')[-1].lower() %}
                          {% if file_ext in ['jpg', 'jpeg', 'png', 'gif', 'bmp'] %}
                            <i class="fas fa-image text-success"></i>
                          {% elif file_ext == 'pdf' %}
                            <i class="fas fa-file-pdf text-danger"></i>
                          {% elif file_ext in ['doc', 'docx'] %}
                            <i class="fas fa-file-word text-primary"></i>
                          {% elif file_ext in ['xls', 'xlsx'] %}
                            <i class="fas fa-file-excel text-success"></i>
                          {% elif file_ext == 'csv' %}
                            <i class="fas fa-file-csv text-info"></i>
                          {% elif file_ext == 'txt' %}
                            <i class="fas fa-file-alt text-secondary"></i>
                          {% else %}
                            <i class="fas fa-file text-muted"></i>
                          {% endif %}
                        </div>
                      {% endif %}

                      <!-- Hover overlay -->
                      <div class="file-overlay">
                        <div class="file-actions">
                          <a href="{{ url_for('repair_work_orders.download_repair_order_file',
                                              repair_order_no=repair_work_order.RepairOrderNo,
                                              file_id=file.id) }}"
                          class="btn btn-sm btn-light me-2"
                          title="Download">
                            <i class="fas fa-download"></i>
                          </a>
                          <button class="btn btn-sm btn-light"
                                  title="View Details"
                                  onclick="showFileDetails({{ file.id }}, '{{ file.filename }}', '{{ file.file_path }}')">
                            <i class="fas fa-eye"></i>
                          </button>
                        </div>
                      </div>
                    </div>

                    <!-- File info -->
                    <div class="file-info">
                      <div class="file-name" title="{{ file.filename }}">
                        {{ file.filename | truncate(20) }}
                      </div>
                      <div class="file-meta">
                        {% set file_size = get_file_size(file.file_path) %}
                        {% if file_size %}
                          <small class="text-muted">{{ file_size }}</small>
                        {% endif %}
                        {% if file.uploaded_at %}
                          <small class="text-muted d-block">{{ file.uploaded_at.strftime('%m/%d/%Y') }}</small>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
          {% endif %}

          <!-- Order Items -->
          {% if repair_work_order.items %}
          <div class="card mb-4 shadow-sm">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-list me-2"></i> Order Items
                <span class="badge bg-secondary ms-2">{{ repair_work_order.items|sum(attribute='Qty')|int }}</span>
              </h5>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                  <thead class="bg-light" style="border-bottom: 1px solid #adb5bd;">



                    <tr>
                      <th>Description</th>
                      <th>Material</th>
                      <th>Qty</th>
                      <th>Condition</th>
                      <th>Color</th>
                      <th>Size/Weight</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for item in repair_work_order.items %}
                    <tr>
                      <td>{{ item.Description or '-' }}</td>
                      <td>{{ item.Material or '-' }}</td>
                      <td>{{ item.Qty or '-' }}</td>
                      <td>{{ item.Condition or '-' }}</td>
                      <td>{{ item.Color or '-' }}</td>
                      <td>{{ item.SizeWgt or '-' }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Status & Quote Sidebar -->
        <div class="col-lg-4">
          <div class="card mb-4 shadow-sm">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-flag me-2"></i> Status & Priority
              </h5>
            </div>
            <div class="card-body">
              <div class="detail-row">
                <div class="detail-label">Return To</div>
                <div class="detail-value">
                  <span class="badge bg-primary">{{ repair_work_order.RETURNTO or 'Not Set' }}</span>
                </div>
              </div>

              <div class="detail-row">
                <div class="detail-label">Return Status</div>
                <div class="detail-value">
                  {% if repair_work_order.RETURNSTATUS == "COMPLETED" %}
                  <span class="status-indicator status-completed"></span>
                  <span class="badge bg-success">{{ repair_work_order.RETURNSTATUS }}</span>
                  {% elif repair_work_order.RETURNSTATUS == "PENDING" %}
                  <span class="status-indicator status-pending"></span>
                  <span class="badge bg-warning">{{ repair_work_order.RETURNSTATUS }}</span>
                  {% else %}
                  <span class="status-indicator status-unknown"></span>
                  <span class="badge bg-secondary">{{ repair_work_order.RETURNSTATUS or 'Unknown' }}</span>
                  {% endif %}
                </div>
              </div>

              <div class="detail-row">
                <div class="detail-label">Priority</div>
                <div class="detail-value">
                  {% if repair_work_order.RushOrder %}
                  <span class="badge bg-warning text-dark">
                    <i class="fas fa-bolt me-1"></i>Rush Order
                  </span>
                  {% endif %}
                  {% if repair_work_order.FirmRush %}
                  <span class="badge bg-danger">
                    <i class="fas fa-exclamation-triangle me-1"></i>Firm Rush
                  </span>
                  {% endif %}
                  {% if not repair_work_order.RushOrder and not repair_work_order.FirmRush %}
                  <span class="text-muted">Normal Priority</span>
                  {% endif %}
                </div>
              </div>

              {% if repair_work_order.RETURNDATE %}
              <div class="detail-row">
                <div class="detail-label">Date Ret. from Sub.</div>
                <div class="detail-value">
                  <i class="fas fa-calendar text-primary me-2"></i>
                  {{ (repair_work_order.RETURNDATE | date_format) or '<span class="text-muted">-</span>' | safe }}
                </div>
              </div>
              {% endif %}
            </div>
          </div>

          <div class="card mb-4 shadow-sm">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-dollar-sign me-2"></i> Quote & Pricing
              </h5>
            </div>
            <div class="card-body">
              <div class="detail-row">
                <div class="detail-label">Quote Status</div>
                <div class="detail-value">
                  {% if repair_work_order.QUOTE == 'YES' %}
                  <span class="badge bg-info">
                    <i class="fas fa-file-invoice me-1"></i> Yes
                  </span>
                  {% elif repair_work_order.QUOTE == 'DONE' %}
                  <span class="badge bg-primary">
                    <i class="fas fa-check-circle me-1"></i> Done
                  </span>
                  {% elif repair_work_order.QUOTE == 'APPROVED' %}
                  <span class="badge bg-success">
                    <i class="fas fa-check-double me-1"></i> Approved
                  </span>
                  {% else %}
                  <span class="text-muted">No Quote</span>
                  {% endif %}
                </div>
              </div>

              <div class="detail-row">
                <div class="detail-label">Repair Price</div>
                <div class="detail-value">
                  <strong>{{ (repair_work_order.CUSTOMERPRICE | price_format) or '<span class="text-muted">TBD</span>' | safe }}</strong>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Additional Information Collapsible Section -->
      <div class="row">
        <div class="col-12">
          <div class="card shadow-sm mb-4">
            <div class="card-header" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#additionalInfoCollapse" aria-expanded="false" aria-controls="additionalInfoCollapse">
              <h5 class="card-title mb-0 d-flex justify-content-between align-items-center">
                <span>
                  <i class="fas fa-info-circle me-2"></i> Additional Information
                </span>
                <i class="fas fa-chevron-down" id="additionalInfoIcon"></i>
              </h5>
            </div>
            <div class="collapse" id="additionalInfoCollapse">
              <div class="card-body">
                <div class="row">
                  <!-- System Information Card -->
                  <div class="col-12">
                    <div class="card shadow-sm h-100">
                      <div class="card-header">
                        <h5 class="card-title mb-0">
                          <i class="fas fa-clock me-2"></i> System Information
                        </h5>
                      </div>
                      <div class="card-body">
                        <div class="detail-row">
                          <div class="detail-label">Created</div>
                          <div class="detail-value">
                            <i class="fas fa-plus-circle text-success me-2"></i>
                            <small>{{ (repair_work_order.created_at | date_format(True)) or '<span class="text-muted">Unknown</span>' | safe }}</small>
                          </div>
                        </div>

                        <div class="detail-row">
                          <div class="detail-label">Updated</div>
                          <div class="detail-value">
                            <i class="fas fa-edit text-info me-2"></i>
                            <small>{{ (repair_work_order.updated_at | date_format(True)) or '<span class="text-muted">Unknown</span>' | safe }}</small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Hidden form for delete action -->
<form id="deleteForm" method="POST" style="display: none;">
</form>

<script>
function confirmDelete(orderNo) {
  const confirmed = confirm(
      `Are you sure you want to delete Work Order #${orderNo}?\n\n` +
      `This action cannot be undone and will permanently delete:\n` +
      `• The work order\n` +
      `• All associated items\n` +
      `• All related data\n\n` +
      `Click OK to confirm deletion.`
  );

  if (confirmed) {
      const form = document.getElementById('deleteForm');
      form.action = `/repair_work_orders/${orderNo}/delete`;
      form.submit();
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // Handle additional information collapse toggle
  const additionalInfoCollapse = document.getElementById('additionalInfoCollapse');
  const additionalInfoIcon = document.getElementById('additionalInfoIcon');

  if (additionalInfoCollapse && additionalInfoIcon) {
    additionalInfoCollapse.addEventListener('show.bs.collapse', function() {
      additionalInfoIcon.classList.remove('fa-chevron-down');
      additionalInfoIcon.classList.add('fa-chevron-up');
    });

    additionalInfoCollapse.addEventListener('hide.bs.collapse', function() {
      additionalInfoIcon.classList.remove('fa-chevron-up');
      additionalInfoIcon.classList.add('fa-chevron-down');
    });
  }
});
</script>
{% endblock %}
