<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <!-- Plotly.js CDN -->
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1 class="dashboard-title">Analytics Dashboard</h1>
            <p class="dashboard-subtitle">Business Performance Overview</p>
        </div>

        {% if error_message %}
        <div class="error-message">
            <strong>Error:</strong> {{ error_message }}
        </div>
        {% endif %}

        <div class="info-message">
            <strong>Data Summary:</strong> Loaded {{ total_records }} records
        </div>

        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card primary">
                <div class="kpi-number">{{ kpis.total_orders }}</div>
                <div class="kpi-label">Total Orders</div>
                <div class="kpi-subtitle">All work orders in system</div>
            </div>
            <div class="kpi-card success">
                <div class="kpi-number">{{ kpis.completed_orders }}</div>
                <div class="kpi-label">Completed Orders</div>
                <div class="kpi-subtitle">{{ kpis.completion_rate }}% completion rate</div>
            </div>
            <div class="kpi-card warning">
                <div class="kpi-number">${{ "%.2f"|format(kpis.total_revenue) }}</div>
                <div class="kpi-label">Total Revenue</div>
                <div class="kpi-subtitle">${{ "%.2f"|format(kpis.avg_revenue) }} average</div>
            </div>
            <div class="kpi-card info">
                <div class="kpi-number">{{ kpis.unique_customers }}</div>
                <div class="kpi-label">Unique Customers</div>
                <div class="kpi-subtitle">Customer base size</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-title">Monthly Orders Trend</div>
                <div id="monthly-chart" class="chart-placeholder">Loading chart...</div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Order Status Distribution</div>
                <div id="status-chart" class="chart-placeholder">Loading chart...</div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Daily Cleaning Throughput</div>
                <div id="throughput-chart" class="chart-placeholder">Loading chart...</div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Cumulative Uncleaned Sq Ft</div>
                <div id="cumulative-chart" class="chart-placeholder">Loading chart...</div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Parse data from Flask
            const monthlyChartData = {{ monthly_chart | safe }};
            const statusChartData = {{ status_chart | safe }};
            const throughputData = {{ throughput | tojson | safe }};
            const cumulativeData = {{ cumulative | tojson | safe }};

            console.log("Monthly chart data:", monthlyChartData);
            console.log("Status chart data:", statusChartData);
            console.log("Throughput data:", throughputData);
            console.log("Cumulative data:", cumulativeData);

            function renderPlotlyChart(containerId, data) {
                if (data && data.data) {
                    try {
                        // Parse if it's a JSON string
                        const chartData = typeof data === 'string' ? JSON.parse(data) : data;
                        Plotly.newPlot(containerId, chartData.data, chartData.layout || {}, {
                            responsive: true,
                            displayModeBar: true
                        });
                    } catch (e) {
                        console.error("Error rendering chart:", e);
                        document.getElementById(containerId).innerHTML = '<div class="loading">Error rendering chart</div>';
                    }
                } else {
                    document.getElementById(containerId).innerHTML = '<div class="loading">No data available</div>';
                }
            }

            // Render main charts
            renderPlotlyChart('monthly-chart', monthlyChartData);
            renderPlotlyChart('status-chart', statusChartData);

            // Throughput chart
            if (throughputData && throughputData.length > 0) {
                const trace = {
                    x: throughputData.map(d => d.datecompleted),
                    y: throughputData.map(d => d.totalsize),
                    mode: 'lines+markers',
                    name: 'Daily Throughput',
                    line: { color: '#3498db', width: 3 },
                    marker: { size: 6 }
                };
                const layout = { 
                    title: 'Daily Cleaning Throughput', 
                    xaxis: { title: 'Date' }, 
                    yaxis: { title: 'Sq Ft' }, 
                    template: 'plotly_white' 
                };
                Plotly.newPlot('throughput-chart', [trace], layout, { responsive: true, displayModeBar: true });
            } else {
                document.getElementById('throughput-chart').innerHTML = '<div class="loading">No throughput data available</div>';
            }

            // Cumulative uncleaned chart
            if (cumulativeData && cumulativeData.length > 0) {
                const trace = {
                    x: cumulativeData.map(d => d.date),
                    y: cumulativeData.map(d => d.cumulative_uncleaned_sqft),
                    mode: 'lines+markers',
                    name: 'Cumulative Uncleaned',
                    line: { color: '#e74c3c', width: 3 },
                    marker: { size: 6 }
                };
                const layout = { 
                    title: 'Cumulative Uncleaned Sq Ft', 
                    xaxis: { title: 'Date' }, 
                    yaxis: { title: 'Sq Ft' }, 
                    template: 'plotly_white' 
                };
                Plotly.newPlot('cumulative-chart', [trace], layout, { responsive: true, displayModeBar: true });
            } else {
                document.getElementById('cumulative-chart').innerHTML = '<div class="loading">No cumulative data available</div>';
            }

            // Resize charts on window resize
            window.addEventListener('resize', () => {
                ['monthly-chart','status-chart','throughput-chart','cumulative-chart'].forEach(id => {
                    Plotly.Plots.resize(document.getElementById(id));
                });
            });
        });
    </script>
</body>
</html>